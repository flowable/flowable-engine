<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.flowable.cmmn.engine.impl.persistence.entity.HistoricCaseInstanceEntityImpl">

    <insert id="insertHistoricCaseInstance" parameterType="org.flowable.cmmn.engine.impl.persistence.entity.HistoricCaseInstanceEntityImpl">
        insert into ${prefix}ACT_CMMN_HI_CASE_INST (ID_, REV_, NAME_, PARENT_ID_, CASE_DEF_ID_, BUSINESS_KEY_, STATE_, START_TIME_, END_TIME_, START_USER_ID_, LAST_REACTIVATION_TIME_, LAST_REACTIVATION_USER_ID_, CALLBACK_ID_, CALLBACK_TYPE_, REFERENCE_ID_, REFERENCE_TYPE_, TENANT_ID_)
        values (
            #{id ,jdbcType=VARCHAR},
            1, #{name ,jdbcType=VARCHAR},
            #{parentId ,jdbcType=VARCHAR},
            #{caseDefinitionId ,jdbcType=VARCHAR},
            #{businessKey ,jdbcType=VARCHAR},
            #{state ,jdbcType=VARCHAR},
            #{startTime ,jdbcType=TIMESTAMP},
            #{endTime ,jdbcType=TIMESTAMP},
            #{startUserId ,jdbcType=VARCHAR},
            #{lastReactivationTime ,jdbcType=TIMESTAMP},
            #{lastReactivationUserId ,jdbcType=VARCHAR},
            #{callbackId, jdbcType=VARCHAR},
            #{callbackType, jdbcType=VARCHAR},
            #{referenceId, jdbcType=VARCHAR},
            #{referenceType, jdbcType=VARCHAR},
            #{tenantId ,jdbcType=VARCHAR}
        )
    </insert>

    <insert id="bulkInsertHistoricCaseInstance" parameterType="java.util.List">
        insert into ${prefix}ACT_CMMN_HI_CASE_INST (ID_, REV_, NAME_, PARENT_ID_, CASE_DEF_ID_, BUSINESS_KEY_, STATE_, START_TIME_, END_TIME_, START_USER_ID_, LAST_REACTIVATION_TIME_, LAST_REACTIVATION_USER_ID_, CALLBACK_ID_, CALLBACK_TYPE_, REFERENCE_ID_, REFERENCE_TYPE_, TENANT_ID_)
        values
        <foreach collection="list" item="historicCaseInstance" index="index" separator=",">
            (
                #{historicCaseInstance.id ,jdbcType=VARCHAR},
                1, #{historicCaseInstance.name ,jdbcType=VARCHAR},
                #{historicCaseInstance.parentId ,jdbcType=VARCHAR},
                #{historicCaseInstance.caseDefinitionId ,jdbcType=VARCHAR},
                #{historicCaseInstance.businessKey ,jdbcType=VARCHAR},
                #{historicCaseInstance.state,jdbcType=VARCHAR},
                #{historicCaseInstance.startTime ,jdbcType=TIMESTAMP},
                #{historicCaseInstance.endTime ,jdbcType=TIMESTAMP},
                #{historicCaseInstance.startUserId ,jdbcType=VARCHAR},
                #{historicCaseInstance.lastReactivationTime ,jdbcType=TIMESTAMP},
                #{historicCaseInstance.lastReactivationUserId ,jdbcType=VARCHAR},
                #{historicCaseInstance.callbackId, jdbcType=VARCHAR},
                #{historicCaseInstance.callbackType, jdbcType=VARCHAR},
                #{historicCaseInstance.referenceId, jdbcType=VARCHAR},
                #{historicCaseInstance.referenceType, jdbcType=VARCHAR},
                #{historicCaseInstance.tenantId ,jdbcType=VARCHAR}
            )
        </foreach>
    </insert>

    <insert id="bulkInsertHistoricCaseInstance" databaseId="oracle" parameterType="java.util.List">
        INSERT ALL
        <foreach collection="list" item="historicCaseInstance" index="index">
            into ${prefix}ACT_CMMN_HI_CASE_INST (ID_, REV_, NAME_, PARENT_ID_, CASE_DEF_ID_, BUSINESS_KEY_, STATE_, START_TIME_, END_TIME_, START_USER_ID_, LAST_REACTIVATION_TIME_, LAST_REACTIVATION_USER_ID_, CALLBACK_ID_, CALLBACK_TYPE_, REFERENCE_ID_, REFERENCE_TYPE_, TENANT_ID_) VALUES
            (
                #{historicCaseInstance.id ,jdbcType=VARCHAR},
                1, #{historicCaseInstance.name ,jdbcType=VARCHAR},
                #{historicCaseInstance.parentId ,jdbcType=VARCHAR},
                #{historicCaseInstance.caseDefinitionId ,jdbcType=VARCHAR},
                #{historicCaseInstance.businessKey ,jdbcType=VARCHAR},
                #{historicCaseInstance.state ,jdbcType=VARCHAR},
                #{historicCaseInstance.startTime ,jdbcType=TIMESTAMP},
                #{historicCaseInstance.endTime ,jdbcType=TIMESTAMP},
                #{historicCaseInstance.startUserId ,jdbcType=VARCHAR},
                #{historicCaseInstance.lastReactivationTime ,jdbcType=TIMESTAMP},
                #{historicCaseInstance.lastReactivationUserId ,jdbcType=VARCHAR},
                #{historicCaseInstance.callbackId, jdbcType=VARCHAR},
                #{historicCaseInstance.callbackType, jdbcType=VARCHAR},
                #{historicCaseInstance.referenceId, jdbcType=VARCHAR},
                #{historicCaseInstance.referenceType, jdbcType=VARCHAR},
                #{historicCaseInstance.tenantId ,jdbcType=VARCHAR}
            )
        </foreach>
        SELECT * FROM dual
    </insert>

    <update id="updateHistoricCaseInstance" parameterType="org.flowable.cmmn.engine.impl.persistence.entity.HistoricCaseInstanceEntityImpl">
        update ${prefix}ACT_CMMN_HI_CASE_INST
        <set>
            REV_ = #{revisionNext, jdbcType=INTEGER},
            <if test="originalPersistentState.name != name">
                NAME_ = #{name, jdbcType=VARCHAR},
            </if>
            <if test="originalPersistentState.parentId != parentId">
                PARENT_ID_ = #{parentId, jdbcType=VARCHAR},
            </if>
            <if test="originalPersistentState.caseDefinitionId != caseDefinitionId">
                CASE_DEF_ID_ = #{caseDefinitionId, jdbcType=VARCHAR},
            </if>
            <if test="originalPersistentState.businessKey != businessKey">
                BUSINESS_KEY_ = #{businessKey, jdbcType=VARCHAR},
            </if>
            <if test="originalPersistentState.state != state">
                STATE_ = #{state, jdbcType=VARCHAR},
            </if>
            <if test="originalPersistentState.startTime != startTime">
                START_TIME_ = #{startTime, jdbcType=TIMESTAMP},
            </if>
            <if test="originalPersistentState.endTime != endTime">
                END_TIME_ = #{endTime, jdbcType=TIMESTAMP},
            </if>
            <if test="originalPersistentState.startUserId != startUserId">
                START_USER_ID_ = #{startUserId, jdbcType=VARCHAR},
            </if>
            <if test="originalPersistentState.lastReactivationTime != lastReactivationTime">
                LAST_REACTIVATION_TIME_ = #{lastReactivationTime, jdbcType=TIMESTAMP},
            </if>
            <if test="originalPersistentState.lastReactivationUserId != lastReactivationUserId">
                LAST_REACTIVATION_USER_ID_ = #{lastReactivationUserId, jdbcType=VARCHAR},
            </if>
            <if test="originalPersistentState.callbackId != callbackId">
                CALLBACK_ID_ = #{callbackId, jdbcType=VARCHAR},
            </if>
            <if test="originalPersistentState.callbackType != callbackType">
                CALLBACK_TYPE_ = #{callbackType, jdbcType=VARCHAR},
            </if>
            <if test="originalPersistentState.referenceId != referenceId">
                REFERENCE_ID_ = #{referenceId, jdbcType=VARCHAR},
            </if>
            <if test="originalPersistentState.referenceType != referenceType">
                REFERENCE_TYPE_ = #{referenceType, jdbcType=VARCHAR},
            </if>
            <if test="originalPersistentState.tenantId != tenantId">
                TENANT_ID_ = #{tenantId, jdbcType=VARCHAR},
            </if>
        </set>
        where ID_ = #{id, jdbcType=VARCHAR}
    </update>

    <delete id="deleteHistoricCaseInstance" parameterType="org.flowable.cmmn.engine.impl.persistence.entity.HistoricCaseInstanceEntityImpl">
        delete from ${prefix}ACT_CMMN_HI_CASE_INST where ID_ = #{id} and REV_ = #{revision}
    </delete>

    <delete id="deleteHistoricCaseInstanceByCaseDefinitionId" parameterType="string">
        delete from ${prefix}ACT_CMMN_HI_CASE_INST where CASE_DEF_ID_ = #{value}
    </delete>

    <resultMap id="historicCaseInstanceResultMap" type="org.flowable.cmmn.engine.impl.persistence.entity.HistoricCaseInstanceEntityImpl">
        <id property="id" column="ID_" jdbcType="VARCHAR" />
        <result property="revision" column="REV_" jdbcType="INTEGER" />
        <result property="name" column="NAME_" jdbcType="VARCHAR" />
        <result property="parentId" column="PARENT_ID_" jdbcType="VARCHAR" />
        <result property="caseDefinitionId" column="CASE_DEF_ID_" jdbcType="VARCHAR" />
        <result property="businessKey" column="BUSINESS_KEY_" jdbcType="VARCHAR" />
        <result property="state" column="STATE_" jdbcType="VARCHAR" />
        <result property="startTime" column="START_TIME_" jdbcType="TIMESTAMP" />
        <result property="endTime" column="END_TIME_" jdbcType="TIMESTAMP" />
        <result property="startUserId" column="START_USER_ID_" jdbcType="VARCHAR" />
        <result property="lastReactivationTime" column="LAST_REACTIVATION_TIME_" jdbcType="TIMESTAMP" />
        <result property="lastReactivationUserId" column="LAST_REACTIVATION_USER_ID_" jdbcType="VARCHAR" />
        <result property="callbackId" column="CALLBACK_ID_" jdbcType="VARCHAR" />
        <result property="callbackType" column="CALLBACK_TYPE_" jdbcType="VARCHAR" />
        <result property="referenceId" column="REFERENCE_ID_" jdbcType="VARCHAR" />
        <result property="referenceType" column="REFERENCE_TYPE_" jdbcType="VARCHAR" />
        <result property="tenantId" column="TENANT_ID_" jdbcType="VARCHAR" />

        <result property="caseDefinitionKey" column="CaseDefinitionKey" jdbcType="VARCHAR" />
        <result property="caseDefinitionName" column="CaseDefinitionName" jdbcType="VARCHAR" />
        <result property="caseDefinitionVersion" column="CaseDefinitionVersion" jdbcType="INTEGER" />
        <result property="caseDefinitionDeploymentId" column="CaseDefinitionDeploymentId" jdbcType="VARCHAR" />
    </resultMap>

    <resultMap id="historicCaseInstanceResultMapWithVariables"
               type="org.flowable.cmmn.engine.impl.persistence.entity.HistoricCaseInstanceEntityImpl"
               extends="historicCaseInstanceResultMap">
        <collection property="queryVariables" column="SCOPE_ID_" javaType="ArrayList"
                    ofType="org.flowable.variable.service.impl.persistence.entity.HistoricVariableInstanceEntityImpl">
            <id property="id" column="VAR_ID_"/>
            <result property="name" column="VAR_NAME_" javaType="String" jdbcType="VARCHAR"/>
            <result property="variableType" column="VAR_TYPE_" javaType="org.flowable.variable.api.types.VariableType"
                    jdbcType="VARCHAR"/>
            <result property="revision" column="VAR_REV_" jdbcType="INTEGER"/>
            <result property="processInstanceId" column="VAR_PROC_INST_ID_" jdbcType="VARCHAR"/>
            <result property="executionId" column="VAR_EXECUTION_ID_" jdbcType="VARCHAR"/>
            <result property="taskId" column="VAR_TASK_ID_" jdbcType="VARCHAR"/>
            <result property="scopeId" column="VAR_SCOPE_ID_" jdbcType="VARCHAR"/>
            <result property="subScopeId" column="VAR_SUB_SCOPE_ID_" jdbcType="VARCHAR"/>
            <result property="scopeType" column="VAR_SCOPE_TYPE_" jdbcType="VARCHAR"/>
            <result property="byteArrayRef" column="VAR_BYTEARRAY_ID_" typeHandler="VariableByteArrayRefTypeHandler"/>
            <result property="doubleValue" column="VAR_DOUBLE_" jdbcType="DOUBLE"/>
            <result property="textValue" column="VAR_TEXT_" jdbcType="VARCHAR"/>
            <result property="textValue2" column="VAR_TEXT2_" jdbcType="VARCHAR"/>
            <result property="longValue" column="VAR_LONG_" jdbcType="BIGINT"/>
        </collection>
    </resultMap>

    <select id="selectHistoricCaseInstance" parameterType="string" resultMap="historicCaseInstanceResultMap">
        select RES.* ,
            CASE_DEF.KEY_ as CaseDefinitionKey,
            CASE_DEF.NAME_ as CaseDefinitionName,
            CASE_DEF.VERSION_ as CaseDefinitionVersion,
            CASE_DEF.DEPLOYMENT_ID_ as CaseDefinitionDeploymentId
        from ${prefix}ACT_CMMN_HI_CASE_INST RES
        left outer join ${prefix}ACT_CMMN_CASEDEF CASE_DEF on RES.CASE_DEF_ID_ = CASE_DEF.ID_
        where RES.ID_ = #{id, jdbcType=VARCHAR}
    </select>

    <select id="selectHistoricCaseInstancesByQueryCriteria" parameterType="org.flowable.cmmn.engine.impl.history.HistoricCaseInstanceQueryImpl" resultMap="historicCaseInstanceResultMap">
        <if test="needsPaging">${limitBefore}</if>
        select RES.* <if test="needsPaging">${limitBetween}</if>,
            CASE_DEF.KEY_ as CaseDefinitionKey,
            CASE_DEF.NAME_ as CaseDefinitionName,
            CASE_DEF.VERSION_ as CaseDefinitionVersion,
            CASE_DEF.DEPLOYMENT_ID_ as CaseDefinitionDeploymentId
        <include refid="selectHistoricCaseInstancesByQueryCriteriaSql" />
        ${orderBy}
        <if test="needsPaging">${limitAfter}</if>
    </select>

    <select id="selectHistoricCaseInstanceCountByQueryCriteria" parameterType="org.flowable.cmmn.engine.impl.history.HistoricCaseInstanceQueryImpl" resultType="long">
        select count(distinct RES.ID_)
        <include refid="selectHistoricCaseInstancesByQueryCriteriaSql" />
    </select>

    <select id="selectHistoricCaseInstancesWithVariablesByQueryCriteria"
            parameterType="org.flowable.cmmn.engine.impl.history.HistoricCaseInstanceQueryImpl"
            resultMap="historicCaseInstanceResultMapWithVariables">
        select RES.*
        <if test="includeCaseVariables">,
            VAR.ID_ as VAR_ID_,
            VAR.NAME_ as VAR_NAME_,
            VAR.VAR_TYPE_ as VAR_TYPE_,
            VAR.REV_ as VAR_REV_,
            VAR.PROC_INST_ID_ as VAR_PROC_INST_ID_,
            VAR.EXECUTION_ID_ as VAR_EXECUTION_ID_,
            VAR.TASK_ID_ as VAR_TASK_ID_,
            VAR.SCOPE_ID_ as VAR_SCOPE_ID_,
            VAR.SUB_SCOPE_ID_ as VAR_SUB_SCOPE_ID_,
            VAR.SCOPE_TYPE_ as VAR_SCOPE_TYPE_,
            VAR.BYTEARRAY_ID_ as VAR_BYTEARRAY_ID_,
            VAR.DOUBLE_ as VAR_DOUBLE_,
            VAR.TEXT_ as VAR_TEXT_,
            VAR.TEXT2_ as VAR_TEXT2_,
            VAR.LAST_UPDATED_TIME_ as VAR_LAST_UPDATED_TIME_,
            VAR.LONG_ as VAR_LONG_
        </if>
        FROM (
            <!-- top 100 percent is only needed when doing order by in a subselect -->
            <if test="needsPaging">${limitBefore}</if>
            select <if test="_databaseId == 'mssql'">top 100 percent</if> RES.* <if test="needsPaging">${limitBetween}</if>,
            CASE_DEF.KEY_ as CaseDefinitionKey,
            CASE_DEF.NAME_ as CaseDefinitionName,
            CASE_DEF.VERSION_ as CaseDefinitionVersion,
            CASE_DEF.DEPLOYMENT_ID_ as CaseDefinitionDeploymentId
            <include refid="selectHistoricCaseInstancesWithVariablesByQueryCriteriaSql"/>
            ${orderBy}
            <if test="needsPaging">${limitAfter}</if>
        ) RES
        left outer join ${prefix}ACT_HI_VARINST VAR ON VAR.PROC_INST_ID_ is null and RES.ID_ = VAR.SCOPE_ID_ and VAR.SCOPE_TYPE_ = 'cmmn' and VAR.SUB_SCOPE_ID_ is null
        <if test="needsCaseDefinitionOuterJoin">
            left outer join ${prefix}ACT_CMMN_CASEDEF CASE_DEF on RES.CASE_DEF_ID_ = CASE_DEF.ID_
        </if>
        ${outerJoinOrderBy}
    </select>

    <sql id="selectHistoricCaseInstancesWithVariablesByQueryCriteriaSql">
        from ${prefix}ACT_CMMN_HI_CASE_INST RES
        <!--
            Doing a join on the definition table is OK, since it is a 1:1 relationship.
            This has to be an outer join because historic data might exists, but definitions might have been deleted
        -->
        left outer join ${prefix}ACT_CMMN_CASEDEF CASE_DEF on RES.CASE_DEF_ID_ = CASE_DEF.ID_
        <include refid="commonSelectHistoricCaseInstancesByQueryCriteriaSql"/>
    </sql>

    <sql id="selectHistoricCaseInstancesByQueryCriteriaSql">
        from ${prefix}ACT_CMMN_HI_CASE_INST RES
        <!--
            Doing a join on the definition table is OK, since it is a 1:1 relationship.
            This has to be an outer join because historic data might exists, but definitions might have been deleted
        -->
        left outer join ${prefix}ACT_CMMN_CASEDEF CASE_DEF on RES.CASE_DEF_ID_ = CASE_DEF.ID_
        <include refid="commonSelectHistoricCaseInstancesByQueryCriteriaSql"/>
    </sql>
    
    <delete id="bulkDeleteHistoricCaseInstances">
        delete from ${prefix}ACT_CMMN_HI_CASE_INST
        <where>
          <include refid="commonCaseInstanceQuerySql">
            <property name="queryTablePrefix" value=""/>
          </include>
          <foreach item="orQueryObject" index="orIndex" collection="orQueryObjects">
            and
            <trim prefix="(" prefixOverrides="OR" suffix=")">
              <include refid="commonCaseInstanceOrQuerySql">
                <property name="queryTablePrefix" value=""/>
              </include>
            </trim>
          </foreach>
        </where>
    </delete>

    <sql id="commonSelectHistoricCaseInstancesByQueryCriteriaSql">
        <where>
            <include refid="commonCaseInstanceQuerySql">
                <property name="queryTablePrefix" value="RES."/>
            </include>
            <if test="caseDefinitionKey != null">
                and CASE_DEF.KEY_ = #{caseDefinitionKey}
            </if>
            <if test="caseDefinitionKeys != null">
                and CASE_DEF.KEY_ IN
                <foreach item="caseDefinitionKey" index="index" collection="caseDefinitionKeys" open="(" separator="," close=")">
                    #{caseDefinitionKey}
                </foreach>
            </if>
            <if test="caseDefinitionCategory != null">
                and CASE_DEF.CATEGORY_ = #{caseDefinitionCategory}
            </if>
            <if test="caseDefinitionName != null">
                and CASE_DEF.NAME_ = #{caseDefinitionName}
            </if>
            <if test="deploymentId != null">
                and CASE_DEF.DEPLOYMENT_ID_ = #{deploymentId}
            </if>
            <if test="deploymentIds != null &amp;&amp; deploymentIds.size() &gt; 0">
                and CASE_DEF.DEPLOYMENT_ID_ IN
                <foreach item="deploymentId" index="index" collection="deploymentIds"
                         open="(" separator="," close=")">
                  #{deploymentId}
                </foreach>
            </if>
            <foreach collection="queryVariableValues" index="index" item="queryVariableValue">
                <choose>
                    <when test="queryVariableValue.operator.equals('EXISTS')">
                      and EXISTS (select ID_ from ${prefix}ACT_HI_VARINST where NAME_ = #{queryVariableValue.name} and RES.ID_ = SCOPE_ID_ and SUB_SCOPE_ID_ is null and SCOPE_TYPE_ = 'cmmn')
                    </when>
                    <when test="queryVariableValue.operator.equals('NOT_EXISTS')">
                      and NOT EXISTS (select ID_ from ${prefix}ACT_HI_VARINST where NAME_ = #{queryVariableValue.name} and RES.ID_ = SCOPE_ID_ and SUB_SCOPE_ID_ is null and SCOPE_TYPE_ = 'cmmn')
                    </when>
                    <otherwise>
                        and exists (
                            select 1
                            from ${prefix}ACT_HI_VARINST V
                            <where>
                                RES.ID_ = V.SCOPE_ID_
                                and V.SUB_SCOPE_ID_ is null
                                and V.SCOPE_TYPE_ = 'cmmn'

                                <if test="queryVariableValue.name != null">
                                    <!-- Match-all variable-names when name is null -->
                                    and V.NAME_= #{queryVariableValue.name}
                                </if>
                                <if test="queryVariableValue.needsTypeCheck()">
                                    and V.VAR_TYPE_ = #{queryVariableValue.type}
                                </if>
                                <if test="queryVariableValue.textValue != null &amp;&amp; queryVariableValue.longValue == null &amp;&amp; queryVariableValue.doubleValue == null">
                                    <choose>
                                        <when test="queryVariableValue.operator.equals('EQUALS_IGNORE_CASE') || queryVariableValue.operator.equals('NOT_EQUALS_IGNORE_CASE') || queryVariableValue.operator.equals('LIKE_IGNORE_CASE')">
                                            and (lower(V.TEXT_)
                                        </when>
                                        <otherwise>
                                            and (V.TEXT_
                                        </otherwise>
                                    </choose>
                                    <choose>
                                        <when test="queryVariableValue.operator.equals('LIKE') || queryVariableValue.operator.equals('LIKE_IGNORE_CASE')">LIKE</when>
                                        <otherwise><include refid="variableOperator" /></otherwise>
                                    </choose>
                                    #{queryVariableValue.textValue}
                                    <choose>
                                        <when test="queryVariableValue.operator.equals('LIKE') || queryVariableValue.operator.equals('LIKE_IGNORE_CASE')">${wildcardEscapeClause}</when>
                                    </choose>
                                    <if test="queryVariableValue.operator.equals('NOT_EQUALS') || queryVariableValue.operator.equals('NOT_EQUALS_IGNORE_CASE')">
                                        or V.TEXT_ is null
                                    </if>
                                    )
                                </if>
                                <if test="queryVariableValue.textValue2 != null">
                                    and V.TEXT2_
                                    <choose>
                                        <when test="queryVariableValue.operator.equals('LIKE')">LIKE</when>
                                        <otherwise><include refid="variableOperator" /></otherwise>
                                    </choose>
                                    #{queryVariableValue.textValue2}
                                    <choose>
                                        <when test="queryVariableValue.operator.equals('LIKE')">${wildcardEscapeClause}</when>
                                    </choose>
                                </if>
                                <if test="queryVariableValue.longValue != null">
                                    and (V.LONG_
                                    <include refid="variableOperator" />
                                    #{queryVariableValue.longValue}
                                    <if test="queryVariableValue.operator.equals('NOT_EQUALS') || queryVariableValue.operator.equals('NOT_EQUALS_IGNORE_CASE')">
                                        or V.LONG_ is null
                                    </if>
                                    )
                                </if>
                                <if test="queryVariableValue.doubleValue != null">
                                    and (V.DOUBLE_
                                    <include refid="variableOperator" />
                                    #{queryVariableValue.doubleValue}
                                    <if test="queryVariableValue.operator.equals('NOT_EQUALS') || queryVariableValue.operator.equals('NOT_EQUALS_IGNORE_CASE')">
                                        or V.DOUBLE_ is null
                                    </if>
                                    )
                                </if>
                                <!-- Null variable type -->
                                <if test="queryVariableValue.textValue == null &amp;&amp; queryVariableValue.textValue2 == null &amp;&amp; queryVariableValue.longValue == null &amp;&amp; queryVariableValue.doubleValue == null">
                                    <choose>
                                        <when test="queryVariableValue.operator.equals('NOT_EQUALS')">
                                            and (V.TEXT_ is not null or V.TEXT2_ is not null or V.LONG_ is not null or V.DOUBLE_ is not null or V.BYTEARRAY_ID_ is not null)
                                        </when>
                                        <otherwise>
                                            and V.TEXT_ is null and V.TEXT2_ is null and V.LONG_ is null and V.DOUBLE_ is null and V.BYTEARRAY_ID_ is null
                                        </otherwise>
                                    </choose>
                                </if>
                            </where>
                        )
                    </otherwise>
                </choose>
            </foreach>

            <!-- or queries -->
            <foreach item="orQueryObject" index="orIndex" collection="orQueryObjects">
            and
                <trim prefix="(" prefixOverrides="OR" suffix=")">
                    <include refid="commonCaseInstanceOrQuerySql">
                        <property name="queryTablePrefix" value="RES."/>
                    </include>
                    <if test="orQueryObject.caseDefinitionKey != null">
                        or CASE_DEF.KEY_ = #{orQueryObject.caseDefinitionKey}
                    </if>
                    <if test="orQueryObject.caseDefinitionKeys != null &amp;&amp; orQueryObject.caseDefinitionKeys.size() &gt; 0">
                        or CASE_DEF.KEY_ IN
                        <foreach item="caseDefinitionKey" index="index" collection="orQueryObject.caseDefinitionKeys" open="(" separator="," close=")">
                            #{caseDefinitionKey}
                        </foreach>
                    </if>
                    <if test="orQueryObject.caseDefinitionCategory != null">
                        or CASE_DEF.CATEGORY_ = #{orQueryObject.caseDefinitionCategory}
                    </if>
                    <if test="orQueryObject.caseDefinitionName != null">
                        or CASE_DEF.NAME_ = #{orQueryObject.caseDefinitionName}
                    </if>
                    <if test="orQueryObject.caseDefinitionVersion != null">
                        or CASE_DEF.VERSION_ = #{orQueryObject.caseDefinitionVersion}
                    </if>
                    <if test="orQueryObject.deploymentId != null">
                        or CASE_DEF.DEPLOYMENT_ID_ = #{orQueryObject.deploymentId}
                    </if>
                    <if test="orQueryObject.deploymentIds != null &amp;&amp; orQueryObject.deploymentIds.size() &gt; 0">
                        or CASE_DEF.DEPLOYMENT_ID_ IN
                        <foreach item="deploymentId" index="index" collection="orQueryObject.deploymentIds"
                                 open="(" separator="," close=")">
                            #{deploymentId}
                        </foreach>
                    </if>
                    <foreach collection="orQueryObject.queryVariableValues" index="index" item="queryVariableValue">
                        or
                        <trim prefix="(" prefixOverrides="AND" suffix=")">
                        <choose>
                            <when test="queryVariableValue.operator.equals('EXISTS')">
                                and EXISTS (select ID_ from ${prefix}ACT_HI_VARINST where NAME_ = #{queryVariableValue.name} and RES.ID_ = SCOPE_ID_ and
                                SUB_SCOPE_ID_ is null and SCOPE_TYPE_ = 'cmmn')
                            </when>
                            <when test="queryVariableValue.operator.equals('NOT_EXISTS')">
                                and NOT EXISTS (select ID_ from ${prefix}ACT_HI_VARINST where NAME_ = #{queryVariableValue.name} and RES.ID_ = SCOPE_ID_ and
                                SUB_SCOPE_ID_ is null and SCOPE_TYPE_ = 'cmmn')
                            </when>
                            <otherwise>
                                and exists (
                                    select 1
                                    from ${prefix}ACT_HI_VARINST V
                                    <where>
                                         RES.ID_ = V.SCOPE_ID_
                                         and V.SUB_SCOPE_ID_ is null
                                         and V.SCOPE_TYPE_ = 'cmmn'
                                        <if test="queryVariableValue.name != null">
                                            <!-- Match-all variable-names when name is null -->
                                            and V.NAME_= #{queryVariableValue.name}
                                        </if>
                                        <if test="queryVariableValue.needsTypeCheck()">
                                            and V.VAR_TYPE_ = #{queryVariableValue.type}
                                        </if>
                                        <if test="queryVariableValue.textValue != null &amp;&amp; queryVariableValue.longValue == null &amp;&amp; queryVariableValue.doubleValue == null">
                                            <choose>
                                                <when test="queryVariableValue.operator.equals('EQUALS_IGNORE_CASE') || queryVariableValue.operator.equals('NOT_EQUALS_IGNORE_CASE') || queryVariableValue.operator.equals('LIKE_IGNORE_CASE')">
                                                    and (lower(V.TEXT_)
                                                </when>
                                                <otherwise>
                                                    and (V.TEXT_
                                                </otherwise>
                                            </choose>
                                            <choose>
                                                <when test="queryVariableValue.operator.equals('LIKE') || queryVariableValue.operator.equals('LIKE_IGNORE_CASE')">LIKE</when>
                                                <otherwise>
                                                    <include refid="variableOperator"/>
                                                </otherwise>
                                            </choose>
                                            #{queryVariableValue.textValue}
                                            <choose>
                                                <when test="queryVariableValue.operator.equals('LIKE') || queryVariableValue.operator.equals('LIKE_IGNORE_CASE')">${wildcardEscapeClause}</when>
                                            </choose>
                                            <if test="queryVariableValue.operator.equals('NOT_EQUALS') || queryVariableValue.operator.equals('NOT_EQUALS_IGNORE_CASE')">
                                                or V.TEXT_ is null
                                            </if>
                                            )
                                        </if>
                                        <if test="queryVariableValue.textValue2 != null">
                                            and V.TEXT2_
                                            <choose>
                                                <when test="queryVariableValue.operator.equals('LIKE')">LIKE</when>
                                                <otherwise><include refid="variableOperator" /></otherwise>
                                            </choose>
                                            #{queryVariableValue.textValue2}
                                            <choose>
                                                <when test="queryVariableValue.operator.equals('LIKE')">${wildcardEscapeClause}</when>
                                            </choose>
                                        </if>
                                        <if test="queryVariableValue.longValue != null">
                                            and (V.LONG_
                                            <include refid="variableOperator" />
                                            #{queryVariableValue.longValue}
                                            <if test="queryVariableValue.operator.equals('NOT_EQUALS') || queryVariableValue.operator.equals('NOT_EQUALS_IGNORE_CASE')">
                                                or V.LONG_ is null
                                            </if>
                                            )
                                        </if>
                                        <if test="queryVariableValue.doubleValue != null">
                                            and (V.DOUBLE_
                                            <include refid="variableOperator" />
                                            #{queryVariableValue.doubleValue}
                                            <if test="queryVariableValue.operator.equals('NOT_EQUALS') || queryVariableValue.operator.equals('NOT_EQUALS_IGNORE_CASE')">
                                                or V.DOUBLE_ is null
                                            </if>
                                            )
                                        </if>
                                        <!-- Null variable type -->
                                        <if test="queryVariableValue.textValue == null &amp;&amp; queryVariableValue.textValue2 == null &amp;&amp; queryVariableValue.longValue == null &amp;&amp; queryVariableValue.doubleValue == null">
                                            <choose>
                                                <when test="queryVariableValue.operator.equals('NOT_EQUALS')">
                                                    and (V.TEXT_ is not null or V.TEXT2_ is not null or V.LONG_ is not null or V.DOUBLE_ is not null or V.BYTEARRAY_ID_ is not null)
                                                </when>
                                                <otherwise>
                                                    and V.TEXT_ is null and V.TEXT2_ is null and V.LONG_ is null and V.DOUBLE_ is null and V.BYTEARRAY_ID_ is null
                                                </otherwise>
                                            </choose>
                                        </if>
                                    </where>
                                )
                            </otherwise>
                        </choose>
                        </trim>
                    </foreach>
                    <!-- or end -->
                </trim>
            </foreach>
        </where>
    </sql>

    <sql id="commonCaseInstanceQuerySql">
        <if test="caseInstanceId != null">
            ${queryTablePrefix}ID_ = #{caseInstanceId}
        </if>
        <if test="caseInstanceIds != null &amp;&amp; caseInstanceIds.size() &gt; 0">
            and ${queryTablePrefix}ID_ IN
            <foreach item="caseInstanceId" index="index" collection="caseInstanceIds"
                     open="(" separator="," close=")">
              #{caseInstanceId}
            </foreach>
        </if>
        <if test="caseInstanceNameLikeIgnoreCase != null">
            and lower(${queryTablePrefix}NAME_) LIKE lower(#{caseInstanceNameLikeIgnoreCase}${wildcardEscapeClause})
        </if>
        <if test="caseDefinitionId != null">
            and ${queryTablePrefix}CASE_DEF_ID_ = #{caseDefinitionId}
        </if>
        <if test="caseDefinitionIds != null">
            and ${queryTablePrefix}CASE_DEF_ID_ IN
            <foreach item="caseDefinitionId" index="index" collection="caseDefinitionIds" open="(" separator="," close=")">
                #{caseDefinitionId}
            </foreach>
        </if>
        <if test="caseInstanceParentId != null">
            and ${queryTablePrefix}PARENT_ID_ = #{caseInstanceParentId}
        </if>
        <if test="businessKey != null">
            and ${queryTablePrefix}BUSINESS_KEY_ = #{businessKey}
        </if>
        <if test="finished">
            and ${queryTablePrefix}END_TIME_ is not null
        </if>
        <if test="unfinished">
            and ${queryTablePrefix}END_TIME_ is null
        </if>
        <if test="startedBefore != null">
            and ${queryTablePrefix}START_TIME_ &lt;= #{startedBefore}
        </if>
        <if test="startedAfter != null">
            and ${queryTablePrefix}START_TIME_ &gt;= #{startedAfter}
        </if>
        <if test="finishedBefore != null">
            and ${queryTablePrefix}END_TIME_ &lt;= #{finishedBefore}
        </if>
        <if test="finishedAfter != null">
            and ${queryTablePrefix}END_TIME_ &gt;= #{finishedAfter}
        </if>
        <if test="startedBy != null">
            and ${queryTablePrefix}START_USER_ID_ = #{startedBy}
        </if>
        <if test="lastReactivatedBefore != null">
            and ${queryTablePrefix}LAST_REACTIVATION_TIME_ &lt;= #{lastReactivatedBefore}
        </if>
        <if test="lastReactivatedAfter != null">
            and ${queryTablePrefix}LAST_REACTIVATION_TIME_ &gt;= #{lastReactivatedAfter}
        </if>
        <if test="lastReactivatedBy != null">
            and ${queryTablePrefix}LAST_REACTIVATION_USER_ID_ = #{lastReactivatedBy}
        </if>
        <if test="callbackId != null">
            and ${queryTablePrefix}CALLBACK_ID_ = #{callbackId}
        </if>
        <if test="callbackType != null">
            and ${queryTablePrefix}CALLBACK_TYPE_ = #{callbackType}
        </if>
        <if test="referenceId != null">
            and ${queryTablePrefix}REFERENCE_ID_ = #{referenceId}
        </if>
        <if test="referenceType != null">
            and ${queryTablePrefix}REFERENCE_TYPE_ = #{referenceType}
        </if>
        <if test="tenantId != null">
            and ${queryTablePrefix}TENANT_ID_ = #{tenantId}
        </if>
        <if test="withoutTenantId">
            and (${queryTablePrefix}TENANT_ID_ is null or ${queryTablePrefix}TENANT_ID_ = '')
        </if>
        <if test="activePlanItemDefinitionId != null">
            and EXISTS(select ID_ from ${prefix}ACT_CMMN_HI_PLAN_ITEM_INST P where P.CASE_INST_ID_ = ${queryTablePrefix}ID_ and P.ITEM_DEFINITION_ID_ = #{activePlanItemDefinitionId} and P.STATE_ = 'active')
        </if>
        <if test="activePlanItemDefinitionIds != null">
            and EXISTS(select ID_ from ${prefix}ACT_CMMN_HI_PLAN_ITEM_INST P where P.CASE_INST_ID_ = ${queryTablePrefix}ID_ and P.ITEM_DEFINITION_ID_ in
            <foreach item="activePlanItemDefinitionId" index="index" collection="activePlanItemDefinitionIds" open="(" separator="," close=")">
                #{activePlanItemDefinitionId}
            </foreach>
            and P.STATE_ = 'active')
        </if>
        <if test="involvedUser != null">
            and EXISTS(select ID_ from ${prefix}ACT_HI_IDENTITYLINK I where I.SCOPE_ID_ = ${queryTablePrefix}ID_ and I.SCOPE_TYPE_ = 'cmmn' and I.USER_ID_ = #{involvedUser})
        </if>
        <if test="involvedUserIdentityLink != null">
            and EXISTS(select ID_ from ${prefix}ACT_HI_IDENTITYLINK I where I.SCOPE_ID_ = ${queryTablePrefix}ID_ and I.SCOPE_TYPE_ = 'cmmn' and 
            I.USER_ID_ = #{involvedUserIdentityLink.userId} and I.TYPE_ = #{involvedUserIdentityLink.type})
        </if>
        <if test="involvedGroups != null">
            and EXISTS(
                select ID_ from ${prefix}ACT_HI_IDENTITYLINK I where I.SCOPE_ID_ = ${queryTablePrefix}ID_ and I.SCOPE_TYPE_ = 'cmmn' and I.GROUP_ID_ in
                <foreach item="involvedGroup" index="index" collection="involvedGroups" open="(" separator="," close=")">
                    #{involvedGroup}
                </foreach>
            )
        </if>
        <if test="involvedGroupIdentityLink != null">
            and EXISTS(select ID_ from ${prefix}ACT_HI_IDENTITYLINK I where I.SCOPE_ID_ = ${queryTablePrefix}ID_ and I.SCOPE_TYPE_ = 'cmmn' and 
            I.GROUP_ID_ = #{involvedGroupIdentityLink.groupId} and I.TYPE_ = #{involvedGroupIdentityLink.type})
        </if>
    </sql>
    
    <sql id="commonCaseInstanceOrQuerySql">
        <if test="orQueryObject.caseInstanceId != null">
            ${queryTablePrefix}ID_ = #{orQueryObject.caseInstanceId}
        </if>
        <if test="orQueryObject.caseInstanceIds != null &amp;&amp; orQueryObject.caseInstanceIds.size() &gt; 0">
            or ${queryTablePrefix}ID_ IN
            <foreach item="caseInstanceId" index="index" collection="orQueryObject.caseInstanceIds"
                     open="(" separator="," close=")">
                #{caseInstanceId}
            </foreach>
        </if>
        <if test="orQueryObject.caseDefinitionId != null">
            or ${queryTablePrefix}CASE_DEF_ID_ = #{orQueryObject.caseDefinitionId}
        </if>
        <if test="orQueryObject.caseDefinitionIds != null">
            or ${queryTablePrefix}CASE_DEF_ID_ IN
            <foreach item="caseDefinitionId" index="index" collection="orQueryObject.caseDefinitionIds" open="(" separator="," close=")">
                #{caseDefinitionId}
            </foreach>
        </if>
        <if test="orQueryObject.caseInstanceParentId != null">
            or ${queryTablePrefix}PARENT_ID_ = #{orQueryObject.caseInstanceParentId}
        </if>
        <if test="orQueryObject.businessKey != null">
            or ${queryTablePrefix}BUSINESS_KEY_ = #{orQueryObject.businessKey}
        </if>
        <if test="orQueryObject.finished">
            or ${queryTablePrefix}END_TIME_ is not null
        </if>
        <if test="orQueryObject.unfinished">
            or ${queryTablePrefix}END_TIME_ is null
        </if>
        <if test="orQueryObject.startedBefore != null">
            or ${queryTablePrefix}START_TIME_ &lt;= #{orQueryObject.startedBefore}
        </if>
        <if test="orQueryObject.startedAfter != null">
            or ${queryTablePrefix}START_TIME_ &gt;= #{orQueryObject.startedAfter}
        </if>
        <if test="orQueryObject.finishedBefore != null">
            or ${queryTablePrefix}END_TIME_ &lt;= #{orQueryObject.finishedBefore}
        </if>
        <if test="orQueryObject.finishedAfter != null">
            or ${queryTablePrefix}END_TIME_ &gt;= #{orQueryObject.finishedAfter}
        </if>
        <if test="orQueryObject.startedBy != null">
            or ${queryTablePrefix}START_USER_ID_ = #{orQueryObject.startedBy}
        </if>
        <if test="orQueryObject.lastReactivatedBefore != null">
            or ${queryTablePrefix}LAST_REACTIVATED_TIME_ &lt;= #{lastReactivatedBefore}
        </if>
        <if test="orQueryObject.lastReactivatedAfter != null">
            or ${queryTablePrefix}LAST_REACTIVATED_TIME_ &gt;= #{lastReactivatedAfter}
        </if>
        <if test="orQueryObject.lastReactivatedBy != null">
            or ${queryTablePrefix}LAST_REACTIVATED_USER_ID_ = #{lastReactivatedBy}
        </if>
        <if test="orQueryObject.callbackId != null">
            or ${queryTablePrefix}CALLBACK_ID_ = #{orQueryObject.callbackId}
        </if>
        <if test="orQueryObject.callbackType != null">
            or ${queryTablePrefix}CALLBACK_TYPE_ = #{orQueryObject.callbackType}
        </if>
        <if test="orQueryObject.referenceId != null">
            or ${queryTablePrefix}REFERENCE_ID_ = #{orQueryObject.referenceId}
        </if>
        <if test="orQueryObject.referenceType != null">
            or ${queryTablePrefix}REFERENCE_TYPE_ = #{orQueryObject.referenceType}
        </if>
        <if test="orQueryObject.tenantId != null">
            or ${queryTablePrefix}TENANT_ID_ = #{orQueryObject.tenantId}
        </if>
        <if test="orQueryObject.withoutTenantId">
            or (${queryTablePrefix}TENANT_ID_ is null or ${queryTablePrefix}TENANT_ID_ = '')
        </if>
        <if test="activePlanItemDefinitionId != null">
            or EXISTS(select ID_ from ${prefix}ACT_CMMN_HI_PLAN_ITEM_INST P where P.CASE_INST_ID_ = ${queryTablePrefix}ID_ and P.ITEM_DEFINITION_ID_ = #{activePlanItemDefinitionId} and P.STATE_ = 'active')
        </if>
        <if test="activePlanItemDefinitionIds != null">
            or EXISTS(select ID_ from ${prefix}ACT_CMMN_HI_PLAN_ITEM_INST P where P.CASE_INST_ID_ = ${queryTablePrefix}ID_ and P.ITEM_DEFINITION_ID_ in
            <foreach item="activePlanItemDefinitionId" index="index" collection="activePlanItemDefinitionIds" open="(" separator="," close=")">
                #{activePlanItemDefinitionId}
            </foreach>
            and P.STATE_ = 'active')
        </if>
        <if test="orQueryObject.involvedUser != null">
            or EXISTS(select ID_ from ${prefix}ACT_HI_IDENTITYLINK I where I.SCOPE_ID_ = ${queryTablePrefix}ID_ and I.SCOPE_TYPE_ = 'cmmn' and I.USER_ID_ =
            #{orQueryObject.involvedUser})
        </if>
        <if test="orQueryObject.involvedUserIdentityLink != null">
            or EXISTS(select ID_ from ${prefix}ACT_HI_IDENTITYLINK I where I.SCOPE_ID_ = ${queryTablePrefix}ID_ and I.SCOPE_TYPE_ = 'cmmn' and 
            I.USER_ID_ = #{orQueryObject.involvedUserIdentityLink.userId} and I.TYPE_ = #{orQueryObject.involvedUserIdentityLink.type})
        </if>
        <if test="orQueryObject.involvedGroups != null">
            or EXISTS(
            select ID_ from ${prefix}ACT_HI_IDENTITYLINK I where I.SCOPE_ID_ = ${queryTablePrefix}ID_ and I.SCOPE_TYPE_ = 'cmmn' and I.GROUP_ID_ in
            <foreach item="involvedGroup" index="index" collection="orQueryObject.involvedGroups" open="(" separator="," close=")">
                #{involvedGroup}
            </foreach>
            )
        </if>
        <if test="orQueryObject.involvedGroupIdentityLink != null">
            or EXISTS(select ID_ from ${prefix}ACT_HI_IDENTITYLINK I where I.SCOPE_ID_ = ${queryTablePrefix}ID_ and I.SCOPE_TYPE_ = 'cmmn' and 
            I.GROUP_ID_ = #{orQueryObject.involvedGroupIdentityLink.groupId} and I.TYPE_ = #{orQueryObject.involvedGroupIdentityLink.type})
        </if>
    </sql>

    <select id="selectHistoricCaseInstancesByCaseDefinitionId" resultMap="historicCaseInstanceResultMap">
        select * from ${prefix}ACT_CMMN_HI_CASE_INST where CASE_DEF_ID_ = #{parameter}
    </select>

    <sql id="variableOperator">
        <choose>
          <when test="queryVariableValue.operator.equals('EQUALS')">=</when>
          <when test="queryVariableValue.operator.equals('EQUALS_IGNORE_CASE')">=</when>
          <when test="queryVariableValue.operator.equals('NOT_EQUALS')">&lt;&gt;</when>
          <when test="queryVariableValue.operator.equals('NOT_EQUALS_IGNORE_CASE')">&lt;&gt;</when>
          <when test="queryVariableValue.operator.equals('GREATER_THAN')">&gt;</when>
          <when test="queryVariableValue.operator.equals('GREATER_THAN_OR_EQUAL')">&gt;=</when>
          <when test="queryVariableValue.operator.equals('LESS_THAN')">&lt;</when>
          <when test="queryVariableValue.operator.equals('LESS_THAN_OR_EQUAL')">&lt;=</when>
       </choose>
    </sql>

</mapper>
