<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.flowable.cmmn.engine.impl.persistence.entity.CaseInstanceEntityImpl">

    <insert id="insertCaseInstance" parameterType="org.flowable.cmmn.engine.impl.persistence.entity.CaseInstanceEntityImpl">
        insert into ${prefix}ACT_CMMN_RU_CASE_INST (ID_, REV_, PARENT_ID_, CASE_DEF_ID_, BUSINESS_KEY_, NAME_, STATE_, START_TIME_, START_USER_ID_, LAST_REACTIVATION_TIME_, LAST_REACTIVATION_USER_ID_, CALLBACK_ID_, CALLBACK_TYPE_, REFERENCE_ID_, REFERENCE_TYPE_, IS_COMPLETEABLE_, TENANT_ID_, BUSINESS_STATUS_) values (
            #{id, jdbcType=VARCHAR},
            1, #{parentId, jdbcType=VARCHAR},
            #{caseDefinitionId, jdbcType=VARCHAR},
            #{businessKey, jdbcType=NVARCHAR},
            #{name, jdbcType=NVARCHAR},
            #{state, jdbcType=VARCHAR},
            #{startTime, jdbcType=TIMESTAMP},
            #{startUserId, jdbcType=VARCHAR},
            #{lastReactivationTime, jdbcType=TIMESTAMP},
            #{lastReactivationUserId, jdbcType=VARCHAR},
            #{callbackId, jdbcType=VARCHAR},
            #{callbackType, jdbcType=VARCHAR},
            #{referenceId, jdbcType=VARCHAR},
            #{referenceType, jdbcType=VARCHAR},
            #{completeable, jdbcType=BOOLEAN},
            #{tenantId, jdbcType=VARCHAR},
            #{businessStatus, jdbcType=NVARCHAR}
        )
    </insert>

    <insert id="bulkInsertCaseInstance" parameterType="java.util.List">
        insert into ${prefix}ACT_CMMN_RU_CASE_INST (ID_, REV_, PARENT_ID_, CASE_DEF_ID_, BUSINESS_KEY_, NAME_, STATE_, START_TIME_, START_USER_ID_, LAST_REACTIVATION_TIME_, LAST_REACTIVATION_USER_ID_, CALLBACK_ID_, CALLBACK_TYPE_, REFERENCE_ID_, REFERENCE_TYPE_, IS_COMPLETEABLE_, TENANT_ID_, BUSINESS_STATUS_)
        values
        <foreach collection="list" item="caseInstance" index="index" separator=",">
            (
                #{caseInstance.id, jdbcType=VARCHAR},
                1, #{caseInstance.parentId, jdbcType=VARCHAR},
                #{caseInstance.caseDefinitionId, jdbcType=VARCHAR},
                #{caseInstance.businessKey, jdbcType=NVARCHAR},
                #{caseInstance.name, jdbcType=NVARCHAR},
                #{caseInstance.state, jdbcType=VARCHAR},
                #{caseInstance.startTime, jdbcType=TIMESTAMP},
                #{caseInstance.startUserId, jdbcType=VARCHAR},
                #{caseInstance.lastReactivationTime, jdbcType=TIMESTAMP},
                #{caseInstance.lastReactivationUserId, jdbcType=VARCHAR},
                #{caseInstance.callbackId, jdbcType=VARCHAR},
                #{caseInstance.callbackType, jdbcType=VARCHAR},
                #{caseInstance.referenceId, jdbcType=VARCHAR},
                #{caseInstance.referenceType, jdbcType=VARCHAR},
                #{caseInstance.completeable, jdbcType=BOOLEAN},
                #{caseInstance.tenantId, jdbcType=VARCHAR},
                #{caseInstance.businessStatus, jdbcType=NVARCHAR}
            )
        </foreach>
    </insert>

    <insert id="bulkInsertCaseInstance" databaseId="oracle" parameterType="java.util.List">
        INSERT ALL
        <foreach collection="list" item="caseInstance" index="index">
            into ${prefix}ACT_CMMN_RU_CASE_INST (ID_, REV_, PARENT_ID_, CASE_DEF_ID_, BUSINESS_KEY_, NAME_, STATE_, START_TIME_, START_USER_ID_, LAST_REACTIVATION_TIME_, LAST_REACTIVATION_USER_ID_, CALLBACK_ID_, CALLBACK_TYPE_, REFERENCE_ID_, REFERENCE_TYPE_, IS_COMPLETEABLE_, TENANT_ID_, BUSINESS_STATUS_) VALUES
            (
                #{caseInstance.id, jdbcType=VARCHAR},
                1, #{caseInstance.parentId, jdbcType=VARCHAR},
                #{caseInstance.caseDefinitionId, jdbcType=VARCHAR},
                #{caseInstance.businessKey, jdbcType=NVARCHAR},
                #{caseInstance.name, jdbcType=NVARCHAR},
                #{caseInstance.state, jdbcType=VARCHAR},
                #{caseInstance.startTime, jdbcType=TIMESTAMP},
                #{caseInstance.startUserId, jdbcType=VARCHAR},
                #{caseInstance.lastReactivationTime, jdbcType=TIMESTAMP},
                #{caseInstance.lastReactivationUserId, jdbcType=VARCHAR},
                #{caseInstance.callbackId, jdbcType=VARCHAR},
                #{caseInstance.callbackType, jdbcType=VARCHAR},
                #{caseInstance.referenceId, jdbcType=VARCHAR},
                #{caseInstance.referenceType, jdbcType=VARCHAR},
                #{caseInstance.completeable, jdbcType=BOOLEAN},
                #{caseInstance.tenantId, jdbcType=VARCHAR},
                #{caseInstance.businessStatus, jdbcType=NVARCHAR}
            )
        </foreach>
        SELECT * FROM dual
    </insert>

    <update id="updateCaseInstance" parameterType="org.flowable.cmmn.engine.impl.persistence.entity.CaseInstanceEntityImpl">
        update ${prefix}ACT_CMMN_RU_CASE_INST
        <set>
            REV_ = #{revisionNext, jdbcType=INTEGER},
            <if test="originalPersistentState.parentId != parentId">
                PARENT_ID_ = #{parentId, jdbcType=VARCHAR},
            </if>
            <if test="originalPersistentState.caseDefinitionId != caseDefinitionId">
                CASE_DEF_ID_ = #{caseDefinitionId, jdbcType=VARCHAR},
            </if>
            <if test="originalPersistentState.businessKey != businessKey">
                BUSINESS_KEY_ = #{businessKey, jdbcType=NVARCHAR},
            </if>
            <if test="originalPersistentState.name != name">
                NAME_ = #{name, jdbcType=NVARCHAR},
            </if>
            <if test="originalPersistentState.state != state">
                STATE_ = #{state, jdbcType=VARCHAR},
            </if>
            <if test="originalPersistentState.startTime != startTime">
                START_TIME_ = #{startTime, jdbcType=TIMESTAMP},
            </if>
            <if test="originalPersistentState.startUserId != startUserId">
                START_USER_ID_ = #{startUserId, jdbcType=VARCHAR},
            </if>
            <if test="originalPersistentState.lastReactivationTime != lastReactivationTime">
                LAST_REACTIVATION_TIME_ = #{lastReactivationTime, jdbcType=TIMESTAMP},
            </if>
            <if test="originalPersistentState.lastReactivationUserId != lastReactivationUserId">
                LAST_REACTIVATION_USER_ID_ = #{lastReactivationUserId, jdbcType=VARCHAR},
            </if>
            <if test="originalPersistentState.callbackId != callbackId">
                CALLBACK_ID_ = #{callbackId, jdbcType=VARCHAR},
            </if>
            <if test="originalPersistentState.callbackType != callbackType">
                CALLBACK_TYPE_ = #{callbackType, jdbcType=VARCHAR},
            </if>
            <if test="originalPersistentState.referenceId != referenceId">
                REFERENCE_ID_ = #{referenceId, jdbcType=VARCHAR},
            </if>
            <if test="originalPersistentState.referenceType != referenceType">
                REFERENCE_TYPE_ = #{referenceType, jdbcType=VARCHAR},
            </if>
            <if test="originalPersistentState.completeable != completeable">
                IS_COMPLETEABLE_ = #{completeable, jdbcType=BOOLEAN},
            </if>
            <if test="originalPersistentState.tenantId != tenantId">
                TENANT_ID_ = #{tenantId, jdbcType=VARCHAR},
            </if>
            <if test="originalPersistentState.businessStatus != businessStatus">
                BUSINESS_STATUS_ = #{businessStatus, jdbcType=NVARCHAR},
            </if>
        </set>
        where ID_ = #{id, jdbcType=VARCHAR} and REV_ = #{revision, jdbcType=INTEGER}
    </update>

    <update id="updateCaseInstanceLockTime" parameterType="java.util.Map">
        update ${prefix}ACT_CMMN_RU_CASE_INST
        set
          LOCK_TIME_ = #{lockTime, jdbcType=TIMESTAMP},
          LOCK_OWNER_ = #{lockOwner, jdbcType=VARCHAR}
        where ID_ = #{id, jdbcType=VARCHAR}
          and (LOCK_TIME_ is null OR LOCK_TIME_ &lt; #{expirationTime, jdbcType=TIMESTAMP})
    </update>

    <update id="clearCaseInstanceLockTime" parameterType="java.util.Map">
        update ${prefix}ACT_CMMN_RU_CASE_INST
        set
            LOCK_TIME_ = null,
            LOCK_OWNER_ = null
        where ID_ = #{id, jdbcType=VARCHAR}
    </update>

    <update id="clearAllCaseInstanceLockTimes" parameterType="java.util.Map">
        update ${prefix}ACT_CMMN_RU_CASE_INST
        set
            LOCK_TIME_ = null,
            LOCK_OWNER_ = null
        where LOCK_OWNER_ = #{lockOwner, jdbcType=VARCHAR}
    </update>

    <delete id="deleteCaseInstance" parameterType="org.flowable.cmmn.engine.impl.persistence.entity.CaseInstanceEntityImpl">
        delete from ${prefix}ACT_CMMN_RU_CASE_INST where ID_ = #{id, jdbcType=VARCHAR} and REV_ = #{revision, jdbcType=INTEGER}
    </delete>

    <resultMap id="caseInstanceResultMap" type="org.flowable.cmmn.engine.impl.persistence.entity.CaseInstanceEntityImpl">
        <id property="id" column="ID_" jdbcType="VARCHAR" />
        <result property="revision" column="REV_" jdbcType="INTEGER" />
        <result property="parentId" column="PARENT_ID_" jdbcType="VARCHAR" />
        <result property="caseDefinitionId" column="CASE_DEF_ID_" jdbcType="VARCHAR" />
        <result property="businessKey" column="BUSINESS_KEY_" jdbcType="NVARCHAR" />
        <result property="businessStatus" column="BUSINESS_STATUS_" jdbcType="NVARCHAR" />
        <result property="name" column="NAME_" jdbcType="NVARCHAR" />
        <result property="state" column="STATE_" jdbcType="VARCHAR" />
        <result property="startTime" column="START_TIME_" jdbcType="TIMESTAMP" />
        <result property="startUserId" column="START_USER_ID_" jdbcType="VARCHAR" />
        <result property="lastReactivationTime" column="LAST_REACTIVATION_TIME_" jdbcType="TIMESTAMP" />
        <result property="lastReactivationUserId" column="LAST_REACTIVATION_USER_ID_" jdbcType="VARCHAR" />
        <result property="callbackId" column="CALLBACK_ID_" jdbcType="VARCHAR" />
        <result property="callbackType" column="CALLBACK_TYPE_" jdbcType="VARCHAR" />
        <result property="referenceId" column="REFERENCE_ID_" jdbcType="VARCHAR" />
        <result property="referenceType" column="REFERENCE_TYPE_" jdbcType="VARCHAR" />
        <result property="completeable" column="IS_COMPLETEABLE_" jdbcType="BOOLEAN" />
        <result property="lockTime" column="LOCK_TIME_" jdbcType="TIMESTAMP" />
        <result property="lockOwner" column="LOCK_OWNER_" jdbcType="VARCHAR" />
        <result property="tenantId" column="TENANT_ID_" jdbcType="VARCHAR" />

        <result property="caseDefinitionKey" column="CaseDefinitionKey" jdbcType="VARCHAR" />
        <result property="caseDefinitionName" column="CaseDefinitionName" jdbcType="NVARCHAR" />
        <result property="caseDefinitionVersion" column="CaseDefinitionVersion" jdbcType="INTEGER" />
        <result property="caseDefinitionDeploymentId" column="CaseDefinitionDeploymentId" jdbcType="VARCHAR" />
    </resultMap>

    <select id="selectCaseInstance" parameterType="string" resultMap="caseInstanceResultMap">
        select RES.*,
        CASE_DEF.KEY_ as CaseDefinitionKey,
        CASE_DEF.NAME_ as CaseDefinitionName,
        CASE_DEF.VERSION_ as CaseDefinitionVersion,
        CASE_DEF.DEPLOYMENT_ID_ as CaseDefinitionDeploymentId
        from ${prefix}ACT_CMMN_RU_CASE_INST RES
        inner join ${prefix}ACT_CMMN_CASEDEF CASE_DEF on RES.CASE_DEF_ID_ = CASE_DEF.ID_
        where RES.ID_ = #{id, jdbcType=VARCHAR}
    </select>

    <resultMap id="caseInstanceResultMapWithVariables" type="org.flowable.cmmn.engine.impl.persistence.entity.CaseInstanceEntityImpl" extends="caseInstanceResultMap">
        <collection property="queryVariables" column="SCOPE_ID_" javaType="ArrayList"
                    ofType="org.flowable.variable.service.impl.persistence.entity.VariableInstanceEntityImpl">
            <id property="id" column="VAR_ID_" jdbcType="NVARCHAR"/>
            <result property="name" column="VAR_NAME_" javaType="String" jdbcType="NVARCHAR"/>
            <result property="type" column="VAR_TYPE_" javaType="org.flowable.variable.api.types.VariableType" jdbcType="NVARCHAR"/>
            <result property="revision" column="VAR_REV_" jdbcType="INTEGER"/>
            <result property="processInstanceId" column="VAR_PROC_INST_ID_" jdbcType="NVARCHAR"/>
            <result property="executionId" column="VAR_EXECUTION_ID_" jdbcType="NVARCHAR"/>
            <result property="taskId" column="VAR_TASK_ID_" jdbcType="NVARCHAR"/>
            <result property="scopeId" column="VAR_SCOPE_ID_" jdbcType="NVARCHAR"/>
            <result property="subScopeId" column="VAR_SUB_SCOPE_ID_" jdbcType="NVARCHAR"/>
            <result property="scopeType" column="VAR_SCOPE_TYPE_" jdbcType="NVARCHAR"/>
            <result property="metaInfo" column="VAR_META_INFO_" jdbcType="NVARCHAR" />
            <result property="byteArrayRef" column="VAR_BYTEARRAY_ID_" typeHandler="VariableByteArrayRefTypeHandler"/>
            <result property="doubleValue" column="VAR_DOUBLE_" jdbcType="DOUBLE"/>
            <result property="textValue" column="VAR_TEXT_" jdbcType="NVARCHAR"/>
            <result property="textValue2" column="VAR_TEXT2_" jdbcType="NVARCHAR"/>
            <result property="longValue" column="VAR_LONG_" jdbcType="BIGINT"/>
        </collection>
    </resultMap>

    <resultMap id="caseInstanceAndPlanItemInstancesResultMap" type="org.flowable.cmmn.engine.impl.persistence.entity.CaseInstanceEntityImpl" extends="caseInstanceResultMap">
        <collection property="childPlanItemInstances"
                    resultMap="org.flowable.cmmn.engine.impl.persistence.entity.PlanItemInstanceEntityImpl.planItemInstanceResultMap"
                    columnPrefix="PI_" />
    </resultMap>

    <select id="selectCaseInstanceEagerFetchPlanItemInstances" parameterType="java.util.Map" resultMap="caseInstanceAndPlanItemInstancesResultMap">
        select
        C.*,
        P.ID_ as PI_ID_,
        P.REV_ as PI_REV_,
        P.CASE_DEF_ID_ as PI_CASE_DEF_ID_,
        P.DERIVED_CASE_DEF_ID_ as PI_DERIVED_CASE_DEF_ID_,
        P.CASE_INST_ID_ as PI_CASE_INST_ID_,
        P.STAGE_INST_ID_ as PI_STAGE_INST_ID_,
        P.IS_STAGE_ as PI_IS_STAGE_,
        P.ELEMENT_ID_ as PI_ELEMENT_ID_,
        P.ITEM_DEFINITION_ID_ as PI_ITEM_DEFINITION_ID_,
        P.ITEM_DEFINITION_TYPE_ as PI_ITEM_DEFINITION_TYPE_,
        P.NAME_ as PI_NAME_,
        P.STATE_ as PI_STATE_,
        P.CREATE_TIME_ as PI_CREATE_TIME_,
        P.LAST_AVAILABLE_TIME_ as PI_LAST_AVAILABLE_TIME_,
        P.LAST_ENABLED_TIME_ as PI_LAST_ENABLED_TIME_,
        P.LAST_DISABLED_TIME_ as PI_LAST_DISABLED_TIME_,
        P.LAST_STARTED_TIME_ as PI_LAST_STARTED_TIME_,
        P.LAST_SUSPENDED_TIME_ as PI_LAST_SUSPENDED_TIME_,
        P.COMPLETED_TIME_ as PI_COMPLETED_TIME_,
        P.OCCURRED_TIME_ as PI_OCCURRED_TIME_ ,
        P.TERMINATED_TIME_ as PI_TERMINATED_TIME_,
        P.EXIT_TIME_ as PI_EXIT_TIME_,
        P.ENDED_TIME_ as PI_ENDED_TIME_,
        P.START_USER_ID_ as PI_USER_ID_,
        P.ASSIGNEE_ as PI_ASSIGNEE_,
        P.COMPLETED_BY_ as PR_COMPLETED_BY_,
        P.REFERENCE_ID_ as PI_REFERENCE_ID_,
        P.REFERENCE_TYPE_ as PI_REFERENCE_TYPE_,
        P.IS_COMPLETEABLE_ as PI_IS_COMPLETEABLE_,
        P.ENTRY_CRITERION_ID_ as PI_ENTRY_CRITERION_ID_,
        P.EXIT_CRITERION_ID_ as PI_EXIT_CRITERION_ID_,
        P.EXTRA_VALUE_ as PI_EXTRA_VALUE_,
        P.IS_COUNT_ENABLED_ as PI_IS_COUNT_ENABLED_,
        P.VAR_COUNT_ as PI_VAR_COUNT_,
        P.SENTRY_PART_INST_COUNT_ as PI_SENTRY_PART_INST_COUNT_,
        P.TENANT_ID_ as PI_TENANT_ID_,
        CASE_DEF.KEY_ as CaseDefinitionKey,
        CASE_DEF.NAME_ as CaseDefinitionName,
        CASE_DEF.VERSION_ as CaseDefinitionVersion,
        CASE_DEF.DEPLOYMENT_ID_ as CaseDefinitionDeploymentId
        from ${prefix}ACT_CMMN_RU_CASE_INST C
        inner join ${prefix}ACT_CMMN_CASEDEF CASE_DEF on C.CASE_DEF_ID_ = CASE_DEF.ID_
        left join ${prefix}ACT_CMMN_RU_PLAN_ITEM_INST P on C.ID_ = CASE_INST_ID_ and P.ENDED_TIME_ is null
        <where>
            <if test="caseInstanceId != null">
                C.ID_ = #{caseInstanceId, jdbcType=VARCHAR}
            </if>
             <if test="planItemInstanceId != null">
                and C.ID_ = (select CASE_INST_ID_ from ${prefix}ACT_CMMN_RU_PLAN_ITEM_INST where ID_ = #{planItemInstanceId, jdbcType=VARCHAR})
            </if>
        </where>
    </select>

    <select id="selectCaseInstancesByQueryCriteria" parameterType="org.flowable.cmmn.engine.impl.runtime.CaseInstanceQueryImpl" resultMap="caseInstanceResultMap">
        <if test="needsPaging">${limitBefore}</if>
        select RES.* <if test="needsPaging">${limitBetween}</if>,
            CASE_DEF.KEY_ as CaseDefinitionKey,
            CASE_DEF.NAME_ as CaseDefinitionName,
            CASE_DEF.VERSION_ as CaseDefinitionVersion,
            CASE_DEF.DEPLOYMENT_ID_ as CaseDefinitionDeploymentId
        from ${prefix}ACT_CMMN_RU_CASE_INST RES
        <!-- Doing an inner join on the definition table is OK, since it is a 1:1 relationship -->
        inner join ${prefix}ACT_CMMN_CASEDEF CASE_DEF on RES.CASE_DEF_ID_ = CASE_DEF.ID_
        <include refid="commonSelectCaseInstancesByQueryCriteriaSql" />
        ${orderBy}
        <if test="needsPaging">${limitAfter}</if>
    </select>

    <select id="selectCaseInstanceCountByQueryCriteria" parameterType="org.flowable.cmmn.engine.impl.runtime.CaseInstanceQueryImpl" resultType="long">
        select count(distinct RES.ID_) from ${prefix}ACT_CMMN_RU_CASE_INST RES
        <!-- Doing an inner join on the definition table is OK, since it is a 1:1 relationship -->
        inner join ${prefix}ACT_CMMN_CASEDEF CASE_DEF on RES.CASE_DEF_ID_ = CASE_DEF.ID_
        <include refid="commonSelectCaseInstancesByQueryCriteriaSql" />
    </select>

    <select id="selectCaseInstanceWithVariablesByQueryCriteria"
            parameterType="org.flowable.cmmn.engine.impl.runtime.CaseInstanceQueryImpl"
            resultMap="caseInstanceResultMapWithVariables">
        select RES.*
        <if test="includeCaseVariables">,
            VAR.ID_ as VAR_ID_, VAR.NAME_ as VAR_NAME_, VAR.TYPE_ as VAR_TYPE_, VAR.REV_ as VAR_REV_,
            VAR.PROC_INST_ID_ as VAR_PROC_INST_ID_, VAR.EXECUTION_ID_ as VAR_EXECUTION_ID_, VAR.TASK_ID_ as
            VAR_TASK_ID_, VAR.SCOPE_ID_ as VAR_SCOPE_ID_, VAR.SUB_SCOPE_ID_ as VAR_SUB_SCOPE_ID_, VAR.SCOPE_TYPE_ as VAR_SCOPE_TYPE_,
            VAR.META_INFO_ as VAR_META_INFO_,
            VAR.BYTEARRAY_ID_ as VAR_BYTEARRAY_ID_, VAR.DOUBLE_ as VAR_DOUBLE_,
            VAR.TEXT_ as VAR_TEXT_, VAR.TEXT2_ as VAR_TEXT2_, VAR.LONG_ as VAR_LONG_
        </if>
        FROM (
            <!-- top 100 percent is only needed when doing order by in a subselect -->
            <if test="needsPaging">${limitBefore}</if>
            select <if test="_databaseId == 'mssql'">top 100 percent</if> RES.* <if test="needsPaging">${limitBetween}</if>,
            CASE_DEF.KEY_ as CaseDefinitionKey,
            CASE_DEF.NAME_ as CaseDefinitionName,
            CASE_DEF.VERSION_ as CaseDefinitionVersion,
            CASE_DEF.DEPLOYMENT_ID_ as CaseDefinitionDeploymentId
            <include refid="selectCaseInstancesWithVariablesByQueryCriteriaSql"/>
            ${orderBy}
            <if test="needsPaging">${limitAfter}</if>
        ) RES
        left outer join ${prefix}ACT_RU_VARIABLE VAR ON RES.ID_ = VAR.SCOPE_ID_ and VAR.SCOPE_TYPE_= 'cmmn' and VAR.SUB_SCOPE_ID_ is null
            <if test="variableNamesToInclude != null and !variableNamesToInclude.empty">
                and VAR.NAME_ in
                <foreach item="variableName" collection="variableNamesToInclude" open="(" separator="," close=")">
                    #{variableName, jdbcType=NVARCHAR}
                </foreach>
            </if>
        <if test="needsCaseDefinitionOuterJoin">
            inner join ${prefix}ACT_CMMN_CASEDEF CASE_DEF on RES.CASE_DEF_ID_ = CASE_DEF.ID_
        </if>
        ${outerJoinOrderBy}
    </select>

    <sql id="selectCaseInstancesWithVariablesByQueryCriteriaSql">
        from ${prefix}ACT_CMMN_RU_CASE_INST RES
        <!-- Doing an inner join on the definition table is OK, since it is a 1:1 relationship -->
        inner join ${prefix}ACT_CMMN_CASEDEF CASE_DEF on RES.CASE_DEF_ID_ = CASE_DEF.ID_
        <include refid="commonSelectCaseInstancesByQueryCriteriaSql"/>
    </sql>

    <sql id="commonSelectCaseInstancesByQueryCriteriaSql">
        <where>
            <if test="caseInstanceId != null">
                and RES.ID_ = #{caseInstanceId, jdbcType=VARCHAR}
            </if>
            <if test="caseInstanceIds != null &amp;&amp; !caseInstanceIds.empty">
                and (
                <foreach item="caseInstanceIdListItem" index="groupIndex" collection="safeCaseInstanceIds">
                    <if test="groupIndex &gt; 0">
                    or
                    </if>
                    RES.ID_ IN
                    <foreach item="caseInstanceId" index="index" collection="caseInstanceIdListItem" open="(" separator="," close=")">
                      #{caseInstanceId, jdbcType=VARCHAR}
                    </foreach>
                </foreach>
                )
            </if>
            <if test="caseDefinitionId != null">
                and RES.CASE_DEF_ID_ = #{caseDefinitionId, jdbcType=VARCHAR}
            </if>
            <if test="caseDefinitionKey != null">
                and CASE_DEF.KEY_ = #{caseDefinitionKey, jdbcType=VARCHAR}
            </if>
            <if test="caseDefinitionKeyLike != null">
                and CASE_DEF.KEY_ like #{caseDefinitionKeyLike, jdbcType=VARCHAR}${wildcardEscapeClause}
            </if>
            <if test="caseDefinitionKeyLikeIgnoreCase != null">
                and lower(CASE_DEF.KEY_) like lower(#{caseDefinitionKeyLikeIgnoreCase, jdbcType=VARCHAR})${wildcardEscapeClause}
            </if>
            <if test="caseDefinitionIds != null">
                and RES.CASE_DEF_ID_ IN
                <foreach item="caseDefinitionId" index="index" collection="caseDefinitionIds" open="(" separator="," close=")">
                    #{caseDefinitionId, jdbcType=VARCHAR}
                </foreach>
            </if>
            <if test="caseDefinitionKeys != null">
                and CASE_DEF.KEY_ IN
                <foreach item="caseDefinitionKey" index="index" collection="caseDefinitionKeys" open="(" separator="," close=")">
                    #{caseDefinitionKey, jdbcType=VARCHAR}
                </foreach>
            </if>
            <if test="excludeCaseDefinitionKeys != null">
                and CASE_DEF.KEY_ NOT IN
                <foreach item="caseDefinitionKey" index="index" collection="excludeCaseDefinitionKeys" open="(" separator="," close=")">
                    #{caseDefinitionKey, jdbcType=VARCHAR}
                </foreach>
            </if>
            <if test="caseDefinitionCategory != null">
                and CASE_DEF.CATEGORY_ = #{caseDefinitionCategory, jdbcType=VARCHAR}
            </if>
            <if test="caseDefinitionCategoryLike != null">
                and CASE_DEF.CATEGORY_ like #{caseDefinitionCategoryLike, jdbcType=VARCHAR}${wildcardEscapeClause}
            </if>
            <if test="caseDefinitionCategoryLikeIgnoreCase != null">
                and lower(CASE_DEF.CATEGORY_) like lower(#{caseDefinitionCategoryLikeIgnoreCase, jdbcType=VARCHAR})${wildcardEscapeClause}
            </if>
            <if test="caseDefinitionName != null">
                and CASE_DEF.NAME_ = #{caseDefinitionName, jdbcType=NVARCHAR}
            </if>
            <if test="caseDefinitionNameLike != null">
                and CASE_DEF.NAME_ like #{caseDefinitionNameLike, jdbcType=NVARCHAR}${wildcardEscapeClause}
            </if>
            <if test="caseDefinitionNameLikeIgnoreCase != null">
                and lower(CASE_DEF.NAME_) like lower(#{caseDefinitionNameLikeIgnoreCase, jdbcType=NVARCHAR})${wildcardEscapeClause}
            </if>
            <if test="caseDefinitionVersion != null">
                and CASE_DEF.VERSION_ = #{caseDefinitionVersion, jdbcType=INTEGER}
            </if>
            <if test="caseInstanceParentId != null">
                and RES.PARENT_ID_ = #{caseInstanceParentId, jdbcType=VARCHAR}
            </if>
            <if test="name != null">
                and RES.NAME_ = #{name, jdbcType=NVARCHAR}
            </if>
            <if test="nameLike != null">
                and RES.NAME_ like #{nameLike, jdbcType=NVARCHAR}${wildcardEscapeClause}
            </if>
            <if test="nameLikeIgnoreCase != null">
                and lower(RES.NAME_) like lower(#{nameLikeIgnoreCase, jdbcType=NVARCHAR})${wildcardEscapeClause}
            </if>
            <if test="parentScopeId != null">
                and EXISTS(select 1 from ${prefix}ACT_RU_ENTITYLINK LINK where
                    LINK.SCOPE_ID_ = #{parentScopeId, jdbcType=NVARCHAR}
                    and LINK.REF_SCOPE_ID_ = RES.ID_
                    and LINK.HIERARCHY_TYPE_ = 'parent'
                )
            </if>
            <if test="rootScopeId != null">
                and exists(select 1 from ${prefix}ACT_RU_ENTITYLINK LINK where
                    LINK.REF_SCOPE_ID_ = RES.ID_
                    and LINK.ROOT_SCOPE_ID_ = #{rootScopeId, jdbcType=NVARCHAR}
                )
            </if>
            <if test="businessKey != null">
                and RES.BUSINESS_KEY_ = #{businessKey, jdbcType=NVARCHAR}
            </if>
            <if test="businessKeyLike != null">
                and RES.BUSINESS_KEY_ like #{businessKeyLike, jdbcType=NVARCHAR}${wildcardEscapeClause}
            </if>
            <if test="businessKeyLikeIgnoreCase != null">
                and lower(RES.BUSINESS_KEY_) like lower(#{businessKeyLikeIgnoreCase, jdbcType=NVARCHAR})${wildcardEscapeClause}
            </if>
            <if test="businessStatus != null">
                and RES.BUSINESS_STATUS_ = #{businessStatus, jdbcType=NVARCHAR}
            </if>
            <if test="businessStatusLike != null">
                and RES.BUSINESS_STATUS_ like #{businessStatusLike, jdbcType=NVARCHAR}${wildcardEscapeClause}
            </if>
            <if test="businessStatusLikeIgnoreCase != null">
                and lower(RES.BUSINESS_STATUS_) like lower(#{businessStatusLikeIgnoreCase, jdbcType=NVARCHAR})${wildcardEscapeClause}
            </if>
            <if test="startedBefore != null">
                and RES.START_TIME_ &lt;= #{startedBefore, jdbcType=TIMESTAMP}
            </if>
            <if test="startedAfter != null">
                and RES.START_TIME_ &gt;= #{startedAfter, jdbcType=TIMESTAMP}
            </if>
            <if test="startedBy != null">
                and RES.START_USER_ID_ = #{startedBy, jdbcType=VARCHAR}
            </if>
            <if test="state != null">
                and RES.STATE_ = #{state, jdbcType=VARCHAR}
            </if>
            <if test="lastReactivatedBefore != null">
                and RES.LAST_REACTIVATION_TIME_ &lt;= #{lastReactivatedBefore, jdbcType=TIMESTAMP}
            </if>
            <if test="lastReactivatedAfter != null">
                and RES.LAST_REACTIVATION_TIME_ &gt;= #{lastReactivatedAfter, jdbcType=TIMESTAMP}
            </if>
            <if test="lastReactivatedBy != null">
                and RES.LAST_REACTIVATION_USER_ID_ = #{lastReactivatedBy, jdbcType=VARCHAR}
            </if>
            <if test="callbackId != null">
                and RES.CALLBACK_ID_ = #{callbackId, jdbcType=VARCHAR}
            </if>
            <if test="callbackIds != null">
                and RES.CALLBACK_ID_ in
                <foreach item="callbackId" index="index" collection="callbackIds" open="(" separator="," close=")">
                    #{callbackId, jdbcType=VARCHAR}
                </foreach>
            </if>
            <if test="callbackType != null">
                and RES.CALLBACK_TYPE_ = #{callbackType, jdbcType=VARCHAR}
            </if>
            <if test="parentCaseInstanceId != null">
                and EXISTS(select 1 from ${prefix}ACT_CMMN_RU_PLAN_ITEM_INST PLANITEM where
                  PLANITEM.CASE_INST_ID_ = #{parentCaseInstanceId, jdbcType=VARCHAR}
                  and RES.CALLBACK_ID_ = PLANITEM.ID_
                  and RES.CALLBACK_TYPE_ = 'cmmn-1.1-to-cmmn-1.1-child-case'
                )
            </if>
            <if test="referenceId != null">
                and RES.REFERENCE_ID_ = #{referenceId, jdbcType=VARCHAR}
            </if>
            <if test="referenceType != null">
                and RES.REFERENCE_TYPE_ = #{referenceType, jdbcType=VARCHAR}
            </if>
            <if test="completeable">
                and RES.IS_COMPLETEABLE_ = #{completeable, jdbcType=BOOLEAN}
            </if>
            <if test="tenantId != null">
                and RES.TENANT_ID_ = #{tenantId, jdbcType=VARCHAR}
            </if>
            <if test="tenantIdLike != null">
                and RES.TENANT_ID_ like #{tenantIdLike, jdbcType=VARCHAR}
            </if>
            <if test="tenantIdLikeIgnoreCase != null">
                and lower(RES.TENANT_ID_) like lower(#{tenantIdLikeIgnoreCase, jdbcType=VARCHAR})${wildcardEscapeClause}
            </if>
            <if test="withoutTenantId">
                and (RES.TENANT_ID_ is null or RES.TENANT_ID_ = '')
            </if>
            <if test="activePlanItemDefinitionId != null">
                and EXISTS(select ID_ from ${prefix}ACT_CMMN_RU_PLAN_ITEM_INST P where P.CASE_INST_ID_ = RES.ID_ and P.ITEM_DEFINITION_ID_ = #{activePlanItemDefinitionId, jdbcType=VARCHAR} and P.STATE_ = 'active')
            </if>
            <if test="activePlanItemDefinitionIds != null">
                and EXISTS(select ID_ from ${prefix}ACT_CMMN_RU_PLAN_ITEM_INST P where P.CASE_INST_ID_ = RES.ID_ and P.ITEM_DEFINITION_ID_ in
                <foreach item="activePlanItemDefinitionId" index="index" collection="activePlanItemDefinitionIds" open="(" separator="," close=")">
                    #{activePlanItemDefinitionId, jdbcType=VARCHAR}
                </foreach>
                and P.STATE_ = 'active')
            </if>
            <if test="involvedUser != null">
                and EXISTS(select ID_ from ${prefix}ACT_RU_IDENTITYLINK I where I.SCOPE_ID_ = RES.ID_ and I.SCOPE_TYPE_ = 'cmmn' and I.USER_ID_ = #{involvedUser, jdbcType=NVARCHAR})
            </if>
            <if test="involvedUserIdentityLink != null">
            	and EXISTS(select ID_ from ${prefix}ACT_RU_IDENTITYLINK I where I.SCOPE_ID_ = RES.ID_ and I.SCOPE_TYPE_ = 'cmmn' and 
            	I.USER_ID_ = #{involvedUserIdentityLink.userId, jdbcType=NVARCHAR} and I.TYPE_ = #{involvedUserIdentityLink.type, jdbcType=NVARCHAR})
        	</if>
            <if test="involvedGroups != null">
                and EXISTS(
                  select ID_ from ${prefix}ACT_RU_IDENTITYLINK I where I.SCOPE_ID_ = RES.ID_ and I.SCOPE_TYPE_ = 'cmmn' and
                    (
                    <foreach item="involvedGroupListItem" index="groupIndex" collection="safeInvolvedGroups">
                        <if test="groupIndex &gt; 0">
                        or
                        </if>
                        I.GROUP_ID_ IN
                        <foreach item="involvedGroup" index="index" collection="involvedGroupListItem"
                              open="(" separator="," close=")">
                          #{involvedGroup, jdbcType=NVARCHAR}
                        </foreach>
                    </foreach>
                    )
                )
            </if>
            <if test="involvedGroupIdentityLink != null">
	            and EXISTS(select ID_ from ${prefix}ACT_RU_IDENTITYLINK I where I.SCOPE_ID_ = RES.ID_ and I.SCOPE_TYPE_ = 'cmmn' and 
	            I.GROUP_ID_ = #{involvedGroupIdentityLink.groupId, jdbcType=NVARCHAR} and I.TYPE_ = #{involvedGroupIdentityLink.type, jdbcType=NVARCHAR})
	        </if>
            <foreach collection="queryVariableValues" index="index" item="queryVariableValue">
                <choose>
                    <when test="queryVariableValue.operator.equals('EXISTS')">
                      and EXISTS (select ID_ from ${prefix}ACT_RU_VARIABLE where NAME_ = #{queryVariableValue.name, jdbcType=NVARCHAR} and RES.ID_ = SCOPE_ID_ and SUB_SCOPE_ID_ is null and SCOPE_TYPE_ = 'cmmn')
                    </when>
                    <when test="queryVariableValue.operator.equals('NOT_EXISTS')">
                      and NOT EXISTS (select ID_ from ${prefix}ACT_RU_VARIABLE where NAME_ = #{queryVariableValue.name, jdbcType=NVARCHAR} and RES.ID_ = SCOPE_ID_ and SUB_SCOPE_ID_ is null and SCOPE_TYPE_ = 'cmmn')
                    </when>
                    <otherwise>
                        and exists (
                            select 1
                            from ${prefix}ACT_RU_VARIABLE V
                            <where>
                                RES.ID_ = V.SCOPE_ID_
                                and V.SUB_SCOPE_ID_ is null
                                and V.SCOPE_TYPE_ = 'cmmn'
                                <if test="queryVariableValue.name != null">
                                    <!-- Match-all variable-names when name is null -->
                                    and V.NAME_= #{queryVariableValue.name, jdbcType=NVARCHAR}
                                </if>
                                <if test="queryVariableValue.needsTypeCheck()">
                                    and V.TYPE_ = #{queryVariableValue.type, jdbcType=NVARCHAR}
                                </if>
                                <if test="queryVariableValue.textValue != null &amp;&amp; queryVariableValue.longValue == null &amp;&amp; queryVariableValue.doubleValue == null">
                                    <choose>
                                        <when test="queryVariableValue.operator.equals('EQUALS_IGNORE_CASE') || queryVariableValue.operator.equals('NOT_EQUALS_IGNORE_CASE') || queryVariableValue.operator.equals('LIKE_IGNORE_CASE')">
                                            and (lower(V.TEXT_)
                                        </when>
                                        <otherwise>
                                            and (V.TEXT_
                                        </otherwise>
                                    </choose>
                                    <choose>
                                        <when test="queryVariableValue.operator.equals('LIKE') || queryVariableValue.operator.equals('LIKE_IGNORE_CASE')">LIKE</when>
                                        <otherwise><include refid="variableOperator" /></otherwise>
                                    </choose>
                                    #{queryVariableValue.textValue, jdbcType=NVARCHAR}
                                    <choose>
                                        <when test="queryVariableValue.operator.equals('LIKE') || queryVariableValue.operator.equals('LIKE_IGNORE_CASE')">${wildcardEscapeClause}</when>
                                    </choose>
                                    <if test="queryVariableValue.operator.equals('NOT_EQUALS') || queryVariableValue.operator.equals('NOT_EQUALS_IGNORE_CASE')">
                                        or V.TEXT_ is null
                                    </if>
                                    )
                                </if>
                                <if test="queryVariableValue.textValue2 != null">
                                    and V.TEXT2_
                                    <choose>
                                        <when test="queryVariableValue.operator.equals('LIKE')">LIKE</when>
                                        <otherwise><include refid="variableOperator" /></otherwise>
                                    </choose>
                                    #{queryVariableValue.textValue2, jdbcType=NVARCHAR}
                                    <choose>
                                        <when test="queryVariableValue.operator.equals('LIKE')">${wildcardEscapeClause}</when>
                                    </choose>
                                </if>
                                <if test="queryVariableValue.longValue != null">
                                    and (V.LONG_
                                    <include refid="variableOperator" />
                                    #{queryVariableValue.longValue, jdbcType=BIGINT}
                                    <if test="queryVariableValue.operator.equals('NOT_EQUALS') || queryVariableValue.operator.equals('NOT_EQUALS_IGNORE_CASE')">
                                        or V.LONG_ is null
                                    </if>
                                    )
                                </if>
                                <if test="queryVariableValue.doubleValue != null">
                                    and (V.DOUBLE_
                                    <include refid="variableOperator" />
                                    #{queryVariableValue.doubleValue, jdbcType=DOUBLE}
                                    <if test="queryVariableValue.operator.equals('NOT_EQUALS') || queryVariableValue.operator.equals('NOT_EQUALS_IGNORE_CASE')">
                                        or V.DOUBLE_ is null
                                    </if>
                                    )
                                </if>
                                <!-- Null variable type -->
                                <if test="queryVariableValue.textValue == null &amp;&amp; queryVariableValue.textValue2 == null &amp;&amp; queryVariableValue.longValue == null &amp;&amp; queryVariableValue.doubleValue == null">
                                    <choose>
                                        <when test="queryVariableValue.operator.equals('NOT_EQUALS')">
                                            and (V.TEXT_ is not null or V.TEXT2_ is not null or V.LONG_ is not null or V.DOUBLE_ is not null or V.BYTEARRAY_ID_ is not null)
                                        </when>
                                        <otherwise>
                                            and .TEXT_ is null and V.TEXT2_ is null and V.LONG_ is null and V.DOUBLE_ is null and V.BYTEARRAY_ID_ is null
                                        </otherwise>
                                    </choose>
                                </if>
                            </where>
                        )
                    </otherwise>
                </choose>
            </foreach>

        	<!-- or queries -->
            <foreach item="orQueryObject" index="orIndex" collection="orQueryObjects">
                and
                <trim prefix="(" prefixOverrides="OR" suffix=")">

                    <if test="orQueryObject.caseInstanceId != null">
                        or RES.ID_ = #{orQueryObject.caseInstanceId, jdbcType=VARCHAR}
                    </if>
                    <if test="orQueryObject.caseInstanceIds != null &amp;&amp; !orQueryObject.caseInstanceIds.empty">
                        or (
                        <foreach item="caseInstanceIdListItem" index="groupIndex" collection="orQueryObject.safeCaseInstanceIds">
                            <if test="groupIndex &gt; 0">
                            or
                            </if>
                            RES.ID_ IN
                            <foreach item="caseInstanceId" index="index" collection="caseInstanceIdListItem" open="(" separator="," close=")">
                              #{caseInstanceId, jdbcType=VARCHAR}
                            </foreach>
                        </foreach>
                        )
                    </if>
                    <if test="orQueryObject.caseDefinitionId != null">
                        or RES.CASE_DEF_ID_ = #{orQueryObject.caseDefinitionId, jdbcType=VARCHAR}
                    </if>
                    <if test="orQueryObject.caseDefinitionKey != null">
                        or CASE_DEF.KEY_ = #{orQueryObject.caseDefinitionKey, jdbcType=VARCHAR}
                    </if>
                    <if test="orQueryObject.caseDefinitionKeyLike != null">
                        or CASE_DEF.KEY_ like #{orQueryObject.caseDefinitionKeyLike, jdbcType=VARCHAR}${wildcardEscapeClause}
                    </if>
                    <if test="orQueryObject.caseDefinitionKeyLikeIgnoreCase != null">
                        or lower(CASE_DEF.KEY_) like lower(#{orQueryObject.caseDefinitionKeyLikeIgnoreCase, jdbcType=VARCHAR})${wildcardEscapeClause}
                    </if>
                    <if test="orQueryObject.caseDefinitionIds != null">
                        or RES.CASE_DEF_ID_ IN
                        <foreach item="caseDefinitionId" index="index" collection="orQueryObject.caseDefinitionIds" open="(" separator="," close=")">
                            #{caseDefinitionId, jdbcType=VARCHAR}
                        </foreach>
                    </if>
                    <if test="orQueryObject.caseDefinitionKeys != null">
                        or CASE_DEF.KEY_ IN
                        <foreach item="caseDefinitionKey" index="index" collection="orQueryObject.caseDefinitionKeys" open="(" separator="," close=")">
                            #{caseDefinitionKey, jdbcType=VARCHAR}
                        </foreach>
                    </if>
                    <if test="orQueryObject.excludeCaseDefinitionKeys != null">
                        or CASE_DEF.KEY_ NOT IN
                        <foreach item="caseDefinitionKey" index="index" collection="orQueryObject.excludeCaseDefinitionKeys" open="(" separator="," close=")">
                            #{caseDefinitionKey, jdbcType=VARCHAR}
                        </foreach>
                    </if>
                    <if test="orQueryObject.caseDefinitionCategory != null">
                        or CASE_DEF.CATEGORY_ = #{orQueryObject.caseDefinitionCategory, jdbcType=VARCHAR}
                    </if>
                    <if test="orQueryObject.caseDefinitionCategoryLike != null">
                        or CASE_DEF.CATEGORY_ like #{orQueryObject.caseDefinitionCategoryLike, jdbcType=VARCHAR}${wildcardEscapeClause}
                    </if>
                    <if test="orQueryObject.caseDefinitionCategoryLikeIgnoreCase != null">
                        or lower(CASE_DEF.CATEGORY_) like lower(#{orQueryObject.caseDefinitionCategoryLikeIgnoreCase, jdbcType=VARCHAR})${wildcardEscapeClause}
                    </if>
                    <if test="orQueryObject.caseDefinitionName != null">
                        or CASE_DEF.NAME_ = #{orQueryObject.caseDefinitionName, jdbcType=NVARCHAR}
                    </if>
                    <if test="orQueryObject.caseDefinitionNameLike != null">
                        or CASE_DEF.NAME_ like #{orQueryObject.caseDefinitionNameLike, jdbcType=NVARCHAR}${wildcardEscapeClause}
                    </if>
                    <if test="orQueryObject.caseDefinitionNameLikeIgnoreCase != null">
                        or lower(CASE_DEF.NAME_) like lower(#{orQueryObject.caseDefinitionNameLikeIgnoreCase, jdbcType=NVARCHAR})${wildcardEscapeClause}
                    </if>
                    <if test="orQueryObject.caseDefinitionVersion != null">
                        or CASE_DEF.VERSION_ = #{orQueryObject.caseDefinitionVersion, jdbcType=INTEGER}
                    </if>
                    <if test="orQueryObject.caseInstanceParentId != null">
                        or RES.PARENT_ID_ = #{orQueryObject.caseInstanceParentId, jdbcType=VARCHAR}
                    </if>
                    <if test="orQueryObject.name != null">
                        or RES.NAME_ = #{orQueryObject.name, jdbcType=NVARCHAR}
                    </if>
                    <if test="orQueryObject.nameLike != null">
                        or RES.NAME_ like #{orQueryObject.nameLike, jdbcType=NVARCHAR}${wildcardEscapeClause}
                    </if>
                    <if test="orQueryObject.nameLikeIgnoreCase != null">
                        or lower(RES.NAME_) like lower(#{orQueryObject.nameLikeIgnoreCase, jdbcType=NVARCHAR})${wildcardEscapeClause}
                    </if>
                    <if test="orQueryObject.businessKey != null">
                        or RES.BUSINESS_KEY_ = #{orQueryObject.businessKey, jdbcType=NVARCHAR}
                    </if>
                    <if test="orQueryObject.businessKeyLike != null">
                        or RES.BUSINESS_KEY_ like #{orQueryObject.businessKeyLike, jdbcType=NVARCHAR}${wildcardEscapeClause}
                    </if>
                    <if test="orQueryObject.businessKeyLikeIgnoreCase != null">
                        or lower(RES.BUSINESS_KEY_) like lower(#{orQueryObject.businessKeyLikeIgnoreCase, jdbcType=NVARCHAR})${wildcardEscapeClause}
                    </if>
                    <if test="orQueryObject.businessStatus != null">
                        or RES.BUSINESS_STATUS_ = #{orQueryObject.businessStatus, jdbcType=NVARCHAR}
                    </if>
                    <if test="orQueryObject.businessStatusLike != null">
                        or RES.BUSINESS_STATUS_ like #{orQueryObject.businessStatusLike, jdbcType=NVARCHAR}${wildcardEscapeClause}
                    </if>
                    <if test="orQueryObject.businessStatusLikeIgnoreCase != null">
                        or lower(RES.BUSINESS_STATUS_) like lower(#{orQueryObject.businessStatusLikeIgnoreCase, jdbcType=NVARCHAR})${wildcardEscapeClause}
                    </if>
                    <if test="orQueryObject.startedBefore != null">
                        or RES.START_TIME_ &lt;= #{orQueryObject.startedBefore, jdbcType=TIMESTAMP}
                    </if>
                    <if test="orQueryObject.startedAfter != null">
                        or RES.START_TIME_ &gt;= #{orQueryObject.startedAfter, jdbcType=TIMESTAMP}
                    </if>
                    <if test="orQueryObject.startedBy != null">
                        or RES.START_USER_ID_ = #{orQueryObject.startedBy, jdbcType=VARCHAR}
                    </if>
                    <if test="orQueryObject.state != null">
                        or RES.STATE_ = #{orQueryObject.state, jdbcType=VARCHAR}
                    </if>
                    <if test="orQueryObject.lastReactivatedBefore != null">
                        or RES.LAST_REACTIVATED_TIME_ &lt;= #{lastReactivatedBefore, jdbcType=TIMESTAMP}
                    </if>
                    <if test="orQueryObject.lastReactivatedAfter != null">
                        or RES.LAST_REACTIVATED_TIME_ &gt;= #{lastReactivatedAfter, jdbcType=TIMESTAMP}
                    </if>
                    <if test="orQueryObject.lastReactivatedBy != null">
                        or RES.LAST_REACTIVATED_USER_ID_ = #{lastReactivatedBy, jdbcType=VARCHAR}
                    </if>
                    <if test="orQueryObject.callbackId != null">
                        or RES.CALLBACK_ID_ = #{orQueryObject.callbackId, jdbcType=VARCHAR}
                    </if>
                    <if test="orQueryObject.callbackIds != null">
                        or RES.CALLBACK_ID_ in <foreach item="callbackId" index="index" collection="orQueryObject.callbackIds" open="(" separator="," close=")">#{callbackId, jdbcType=VARCHAR}</foreach>
                    </if>
                    <if test="orQueryObject.callbackType != null">
                        or RES.CALLBACK_TYPE_ = #{orQueryObject.callbackType, jdbcType=VARCHAR}
                    </if>
                    <if test="orQueryObject.parentCaseInstanceId != null">
                        or EXISTS(select 1 from ${prefix}ACT_CMMN_RU_PLAN_ITEM_INST PLANITEM where
                          PLANITEM.CASE_INST_ID_ = #{orQueryObject.parentCaseInstanceId, jdbcType=VARCHAR}
                          and RES.CALLBACK_ID_ = PLANITEM.ID_
                          and RES.CALLBACK_TYPE_ = 'cmmn-1.1-to-cmmn-1.1-child-case'
                        )
                    </if>
                    <if test="orQueryObject.referenceId != null">
                        or RES.REFERENCE_ID_ = #{orQueryObject.referenceId, jdbcType=VARCHAR}
                    </if>
                    <if test="orQueryObject.referenceType != null">
                        or RES.REFERENCE_TYPE_ = #{orQueryObject.referenceType, jdbcType=VARCHAR}
                    </if>
                    <if test="orQueryObject.completeable">
                        or RES.IS_COMPLETEABLE_ = #{orQueryObject.completeable, jdbcType=BOOLEAN}
                    </if>
                    <if test="orQueryObject.tenantId != null">
                        or RES.TENANT_ID_ = #{orQueryObject.tenantId, jdbcType=VARCHAR}
                    </if>
                    <if test="orQueryObject.tenantIdLike != null">
                        or RES.TENANT_ID_ like #{orQueryObject.tenantIdLike, jdbcType=VARCHAR}${wildcardEscapeClause}
                    </if>
                    <if test="orQueryObject.tenantIdLikeIgnoreCase != null">
                        or lower(RES.TENANT_ID_) like lower(#{orQueryObject.tenantIdLikeIgnoreCase, jdbcType=VARCHAR})${wildcardEscapeClause}
                    </if>
                    <if test="orQueryObject.withoutTenantId">
                        or (RES.TENANT_ID_ is null or RES.TENANT_ID_ = '')
                    </if>
                    <if test="orQueryObject.activePlanItemDefinitionId != null">
		                or EXISTS(select ID_ from ${prefix}ACT_CMMN_RU_PLAN_ITEM_INST P where P.CASE_INST_ID_ = RES.ID_ and P.ITEM_DEFINITION_ID_ = #{orQueryObject.activePlanItemDefinitionId, jdbcType=VARCHAR} and P.STATE_ = 'active')
		            </if>
		            <if test="orQueryObject.activePlanItemDefinitionIds != null">
		                or EXISTS(select ID_ from ${prefix}ACT_CMMN_RU_PLAN_ITEM_INST P where P.CASE_INST_ID_ = RES.ID_ and P.ITEM_DEFINITION_ID_ in
		                <foreach item="activePlanItemDefinitionId" index="index" collection="orQueryObject.activePlanItemDefinitionIds" open="(" separator="," close=")">
		                    #{activePlanItemDefinitionId, jdbcType=VARCHAR}
		                </foreach>
		                and P.STATE_ = 'active')
		            </if>
                    <if test="orQueryObject.involvedUser != null">
                        or EXISTS(select ID_ from ${prefix}ACT_RU_IDENTITYLINK I where I.SCOPE_ID_ = RES.ID_ and I.SCOPE_TYPE_ = 'cmmn' and I.USER_ID_ =
                        #{orQueryObject.involvedUser, jdbcType=NVARCHAR})
                    </if>
                    <if test="orQueryObject.involvedUserIdentityLink != null">
			            or EXISTS(select ID_ from ${prefix}ACT_RU_IDENTITYLINK I where I.SCOPE_ID_ = RES.ID_ and I.SCOPE_TYPE_ = 'cmmn' and 
			            I.USER_ID_ = #{orQueryObject.involvedUserIdentityLink.userId, jdbcType=NVARCHAR} and I.TYPE_ = #{orQueryObject.involvedUserIdentityLink.type, jdbcType=NVARCHAR})
			        </if>
                    <if test="orQueryObject.involvedGroups != null">
                        or EXISTS(
                          select ID_ from ${prefix}ACT_RU_IDENTITYLINK I where I.SCOPE_ID_ = RES.ID_ and I.SCOPE_TYPE_ = 'cmmn' and
                            (
                            <foreach item="involvedGroupListItem" index="groupIndex" collection="orQueryObject.safeInvolvedGroups">
                                <if test="groupIndex &gt; 0">
                                or
                                </if>
                                I.GROUP_ID_ IN
                                <foreach item="involvedGroup" index="index" collection="involvedGroupListItem"
                                      open="(" separator="," close=")">
                                  #{involvedGroup, jdbcType=NVARCHAR}
                                </foreach>
                            </foreach>
                            )
                        )
                    </if>
					<if test="orQueryObject.involvedGroupIdentityLink != null">
			            or EXISTS(select ID_ from ${prefix}ACT_RU_IDENTITYLINK I where I.SCOPE_ID_ = RES.ID_ and I.SCOPE_TYPE_ = 'cmmn' and 
			            I.GROUP_ID_ = #{orQueryObject.involvedGroupIdentityLink.groupId, jdbcType=NVARCHAR} and I.TYPE_ = #{orQueryObject.involvedGroupIdentityLink.type, jdbcType=NVARCHAR})
			        </if>
                    <if test="orQueryObject.parentScopeId != null">
                        or EXISTS(select 1 from ${prefix}ACT_RU_ENTITYLINK LINK where
                            LINK.SCOPE_ID_ = #{orQueryObject.parentScopeId, jdbcType=NVARCHAR}
                            and LINK.REF_SCOPE_ID_ = RES.ID_
                            and LINK.HIERARCHY_TYPE_ = 'parent'
                        )
                    </if>
                    <if test="orQueryObject.rootScopeId != null">
                        or exists(select 1 from ${prefix}ACT_RU_ENTITYLINK LINK where
                            LINK.REF_SCOPE_ID_ = RES.ID_
                            and LINK.ROOT_SCOPE_ID_ = #{orQueryObject.rootScopeId, jdbcType=NVARCHAR}
                        )
                    </if>
                    <foreach collection="orQueryObject.queryVariableValues" index="index" item="queryVariableValue">
                        or
                        <trim prefix="(" prefixOverrides="AND" suffix=")">
                            <choose>
                                <when test="queryVariableValue.operator.equals('EXISTS')">
                                    and EXISTS (select ID_ from ${prefix}ACT_RU_VARIABLE where NAME_ = #{queryVariableValue.name, jdbcType=NVARCHAR} and RES.ID_ = SCOPE_ID_ and
                                    SUB_SCOPE_ID_
                                    is null and SCOPE_TYPE_ = 'cmmn')
                                </when>
                                <when test="queryVariableValue.operator.equals('NOT_EXISTS')">
                                    and NOT EXISTS (select ID_ from ${prefix}ACT_RU_VARIABLE where NAME_ = #{queryVariableValue.name, jdbcType=NVARCHAR} and RES.ID_ = SCOPE_ID_
                                    and
                                    SUB_SCOPE_ID_ is null and SCOPE_TYPE_ = 'cmmn')
                                </when>
                                <otherwise>
                                    and exists (
                                        select 1
                                        from ${prefix}ACT_RU_VARIABLE V
                                        <where>
                                            RES.ID_ = V.SCOPE_ID_
                                            and V.SUB_SCOPE_ID_ is null
                                            and V.SCOPE_TYPE_ = 'cmmn'
                                            <if test="queryVariableValue.name != null">
                                                <!-- Match-all variable-names when name is null -->
                                                and V.NAME_= #{queryVariableValue.name, jdbcType=NVARCHAR}
                                            </if>
                                            <if test="queryVariableValue.needsTypeCheck()">
                                                and V.TYPE_ = #{queryVariableValue.type, jdbcType=NVARCHAR}
                                            </if>
                                            <if test="queryVariableValue.textValue != null &amp;&amp; queryVariableValue.longValue == null &amp;&amp; queryVariableValue.doubleValue == null">
                                                <choose>
                                                    <when test="queryVariableValue.operator.equals('EQUALS_IGNORE_CASE') || queryVariableValue.operator.equals('NOT_EQUALS_IGNORE_CASE') || queryVariableValue.operator.equals('LIKE_IGNORE_CASE')">
                                                        and (lower(V.TEXT_)
                                                    </when>
                                                    <otherwise>
                                                        and (V.TEXT_
                                                    </otherwise>
                                                </choose>
                                                <choose>
                                                    <when test="queryVariableValue.operator.equals('LIKE') || queryVariableValue.operator.equals('LIKE_IGNORE_CASE')">
                                                        LIKE
                                                    </when>
                                                    <otherwise>
                                                        <include refid="variableOperator"/>
                                                    </otherwise>
                                                </choose>
                                                #{queryVariableValue.textValue, jdbcType=NVARCHAR}
                                                <choose>
                                                    <when test="queryVariableValue.operator.equals('LIKE') || queryVariableValue.operator.equals('LIKE_IGNORE_CASE')">
                                                        ${wildcardEscapeClause}
                                                    </when>
                                                </choose>
                                                <if test="queryVariableValue.operator.equals('NOT_EQUALS') || queryVariableValue.operator.equals('NOT_EQUALS_IGNORE_CASE')">
                                                    or V.TEXT_ is null
                                                </if>
                                                )
                                            </if>
                                            <if test="queryVariableValue.textValue2 != null">
                                                and V.TEXT2_
                                                <choose>
                                                    <when test="queryVariableValue.operator.equals('LIKE')">LIKE</when>
                                                    <otherwise>
                                                        <include refid="variableOperator"/>
                                                    </otherwise>
                                                </choose>
                                                #{queryVariableValue.textValue2, jdbcType=NVARCHAR}
                                                <choose>
                                                    <when test="queryVariableValue.operator.equals('LIKE')">${wildcardEscapeClause}</when>
                                                </choose>
                                            </if>
                                            <if test="queryVariableValue.longValue != null">
                                                and (V.LONG_
                                                <include refid="variableOperator"/>
                                                #{queryVariableValue.longValue, jdbcType=BIGINT}
                                                <if test="queryVariableValue.operator.equals('NOT_EQUALS') || queryVariableValue.operator.equals('NOT_EQUALS_IGNORE_CASE')">
                                                    or V.LONG_ is null
                                                </if>
                                                )
                                            </if>
                                            <if test="queryVariableValue.doubleValue != null">
                                                and (V.DOUBLE_
                                                <include refid="variableOperator"/>
                                                #{queryVariableValue.doubleValue, jdbcType=DOUBLE}
                                                <if test="queryVariableValue.operator.equals('NOT_EQUALS') || queryVariableValue.operator.equals('NOT_EQUALS_IGNORE_CASE')">
                                                    or V.DOUBLE_ is null
                                                </if>
                                                )
                                            </if>
                                            <!-- Null variable type -->
                                            <if test="queryVariableValue.textValue == null &amp;&amp; queryVariableValue.textValue2 == null &amp;&amp; queryVariableValue.longValue == null &amp;&amp; queryVariableValue.doubleValue == null">
                                                <choose>
                                                    <when test="queryVariableValue.operator.equals('NOT_EQUALS')">
                                                        and (V.TEXT_ is not null or V.TEXT2_ is not null or V.LONG_ is not null or
                                                        V.DOUBLE_
                                                        is not null or V.BYTEARRAY_ID_ is not null)
                                                    </when>
                                                    <otherwise>
                                                        and V.TEXT_ is null and V.TEXT2_ is null and V.LONG_ is null and
                                                        V.DOUBLE_ is null
                                                        and V.BYTEARRAY_ID_ is null
                                                    </otherwise>
                                                </choose>
                                            </if>
                                        </where>
                                    )
                                </otherwise>
                            </choose>
                        </trim>
                    </foreach>
                </trim>
            </foreach>
        <!-- or queries end -->

        </where>
    </sql>

    <select id="selectCaseInstancesByCaseDefinitionId" resultMap="caseInstanceResultMap">
        select * from ${prefix}ACT_CMMN_RU_CASE_INST where CASE_DEF_ID_ = #{parameter, jdbcType=VARCHAR}
    </select>

    <sql id="variableOperator">
        <choose>
          <when test="queryVariableValue.operator.equals('EQUALS')">=</when>
          <when test="queryVariableValue.operator.equals('EQUALS_IGNORE_CASE')">=</when>
          <when test="queryVariableValue.operator.equals('NOT_EQUALS')">&lt;&gt;</when>
          <when test="queryVariableValue.operator.equals('NOT_EQUALS_IGNORE_CASE')">&lt;&gt;</when>
          <when test="queryVariableValue.operator.equals('GREATER_THAN')">&gt;</when>
          <when test="queryVariableValue.operator.equals('GREATER_THAN_OR_EQUAL')">&gt;=</when>
          <when test="queryVariableValue.operator.equals('LESS_THAN')">&lt;</when>
          <when test="queryVariableValue.operator.equals('LESS_THAN_OR_EQUAL')">&lt;=</when>
       </choose>
    </sql>

</mapper>
